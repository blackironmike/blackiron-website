<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | 4-Phase Nutrition Blueprint | Black Iron Athletics</title>
    <meta name="description" content="Your personal Athlete Dashboard — track macros, weight, body composition, and phase progress through the 4-Phase Nutrition Blueprint.">
    <meta name="geo.region" content="US-TX">
    <meta name="geo.placename" content="Frisco">
    <link rel="canonical" href="https://www.blackironathletics.com/blueprint-dashboard.html">
    <meta property="og:title" content="My Dashboard | 4-Phase Nutrition Blueprint | Black Iron Athletics">
    <meta property="og:description" content="Your personal Athlete Dashboard — track macros, weight, body composition, and phase progress.">
    <meta property="og:url" content="https://www.blackironathletics.com/blueprint-dashboard.html">
    <meta property="og:image" content="https://www.blackironathletics.com/images/social-share.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Black Iron Athletics">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="My Dashboard | 4-Phase Nutrition Blueprint | Black Iron Athletics">
    <meta name="twitter:description" content="Your personal Athlete Dashboard — track macros, weight, body composition, and phase progress.">
    <meta name="twitter:image" content="https://www.blackironathletics.com/images/social-share.png">
    <link rel="icon" type="image/png" href="images/anvil-favicon.png">
    <link rel="preload" as="image" href="images/hero-blueprint-how-to-use.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"></noscript>
    <style>@font-face{font-family:"Font Awesome 6 Brands";font-display:swap}@font-face{font-family:"Font Awesome 6 Free";font-display:swap}</style>
    <!-- Supabase + Chart.js + PDF -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Force full width - override GHL container */
        body, html {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .container, .hl_page-preview--content {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #000000;
            --dark-gray: #1a1a1a;
            --medium-gray: #333333;
            --light-gray: #cccccc;
            --white: #ffffff;
            --yellow: #FFD202;
            --phase-baseline: #9b59b6;
            --phase-maintain: #2E86C1;
            --phase-cut: #ff0003;
            --phase-build: #27AE60;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            background: var(--black);
            color: var(--white);
            overflow-x: hidden;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        html {
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            line-height: 1.2;
        }

        /* ===== NAV ===== */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 1.5rem 0;
            background: var(--black);
            z-index: 1000;
            border-bottom: 1px solid var(--medium-gray);
        }

        .nav-container {
            max-width: 100%;
            margin: 0;
            padding: 0 4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { height: 50px; }
        .logo a { display: block; height: 100%; }
        .logo img { height: 100%; width: auto; }

        .nav-links {
            display: flex;
            gap: 3rem;
            list-style: none;
            align-items: center;
        }

        .nav-links > li { position: relative; }

        .nav-links a {
            color: var(--white);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 900;
            transition: color 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-links > li > a:hover { color: var(--yellow); }

        .submenu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            min-width: 240px;
            padding: 0.5rem 0;
            border: 1px solid var(--medium-gray);
            list-style: none;
        }

        .submenu li { padding: 0; }

        .submenu a {
            display: block;
            padding: 1rem 1.5rem;
            font-size: 0.85rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .submenu a:hover {
            background: rgba(255, 210, 2, 0.1);
            color: var(--yellow);
            padding-left: 2rem;
        }

        .nav-links > li:hover .submenu { display: block; }

        .has-submenu > a::after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 0.5rem;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid var(--white);
            transition: all 0.3s ease;
        }

        .has-submenu:hover > a::after {
            border-top-color: var(--yellow);
            transform: translateY(2px);
        }

        .nav-cta-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .cta-btn {
            background: var(--yellow);
            color: var(--black);
            padding: 0.9rem 1.5rem;
            border-radius: 0;
            text-decoration: none;
            font-weight: 900;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid var(--yellow);
            white-space: nowrap;
        }

        .cta-btn:hover {
            background: var(--black);
            color: var(--yellow);
        }

        .login-btn {
            color: var(--yellow);
            padding: 0.9rem 1.5rem;
            border-radius: 0;
            text-decoration: none;
            font-weight: 900;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid var(--yellow);
            white-space: nowrap;
            background: transparent;
        }

        .login-btn:hover {
            background: var(--yellow);
            color: var(--black);
        }

        /* ===== HERO ===== */
        .hero {
            margin-top: 0;
            padding-top: 80px;
            min-height: 60vh;
            display: flex;
            align-items: center;
            position: relative;
            background: var(--black);
        }

        .hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.5;
            z-index: 0;
        }

        .hero-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 4rem;
            position: relative;
            z-index: 1;
        }

        .hero-content { max-width: 800px; }

        .hero-subtitle {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
        }

        .hero-content h1 {
            font-weight: 900;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            line-height: 1.1;
            margin-bottom: 2rem;
            text-transform: uppercase;
        }

        .hero-content p {
            font-size: 1.3rem;
            color: var(--light-gray);
            margin-bottom: 3rem;
            font-weight: 500;
            line-height: 1.6;
            max-width: 600px;
        }

        /* ===== BLUEPRINT SUB-NAV ===== */
        .blueprint-subnav {
            background: var(--dark-gray);
            border-bottom: 1px solid var(--medium-gray);
            width: 100%;
            position: relative;
            z-index: 10;
        }

        .blueprint-subnav-container {
            max-width: 100%;
            margin: 0;
            padding: 0 4rem;
            display: flex;
            align-items: center;
            gap: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .blueprint-subnav-container::-webkit-scrollbar {
            display: none;
        }

        .blueprint-subnav a {
            color: var(--light-gray);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 1.25rem;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            display: block;
        }

        .blueprint-subnav a:hover {
            color: var(--yellow);
        }

        .blueprint-subnav a.active {
            color: var(--yellow);
            border-bottom: 2px solid var(--yellow);
        }

        /* ===== SECTIONS ===== */
        .section {
            padding: 6rem 0;
            background: var(--black);
            width: 100%;
        }

        .section-alt { background: var(--dark-gray); }

        .section-container {
            max-width: 100%;
            margin: 0;
            padding: 0 4rem;
        }

        .section-header {
            text-align: center;
            margin-bottom: 4rem;
        }

        .section-subtitle {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
        }

        .section-title {
            font-weight: 900;
            font-size: clamp(2.5rem, 5vw, 4rem);
            margin-bottom: 1.5rem;
            text-transform: uppercase;
        }

        .section-description {
            font-size: 1.2rem;
            color: var(--light-gray);
            max-width: 800px;
            margin: 0 auto;
        }

        .btn-primary {
            background: var(--yellow);
            color: var(--black);
            padding: 1.2rem 3rem;
            text-decoration: none;
            font-weight: 900;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--yellow);
            border-radius: 0;
            display: inline-block;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--black);
            color: var(--yellow);
        }

        .btn-outline {
            background: transparent;
            color: var(--yellow);
            padding: 1.2rem 3rem;
            text-decoration: none;
            font-weight: 900;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--yellow);
            border-radius: 0;
            display: inline-block;
            cursor: pointer;
        }

        .btn-outline:hover {
            background: var(--yellow);
            color: var(--black);
        }

        .btn-secondary {
            background: transparent;
            color: var(--white);
            padding: 1.2rem 3rem;
            text-decoration: none;
            font-weight: 900;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--white);
            border-radius: 0;
            display: inline-block;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--white);
            color: var(--black);
        }

        .btn-small {
            padding: 0.7rem 1.5rem;
            font-size: 0.85rem;
        }

        /* ===== FEATURE CARDS ===== */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .feature-card {
            background: var(--dark-gray);
            padding: 2.5rem 2rem;
            border: 2px solid var(--medium-gray);
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            display: block;
        }

        .section-alt .feature-card {
            background: var(--black);
        }

        .feature-card:hover {
            border-color: var(--yellow);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 210, 2, 0.2);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: var(--yellow);
            margin-bottom: 1.5rem;
        }

        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            color: var(--white);
        }

        .feature-card p {
            color: var(--light-gray);
            line-height: 1.8;
        }

        /* ===== STAT CARDS ===== */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stats-row-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .stat-card {
            background: var(--black);
            border: 2px solid var(--medium-gray);
            padding: 1.25rem 1rem;
            text-align: center;
        }

        .section .stat-card {
            background: var(--dark-gray);
        }

        .section-alt .stat-card {
            background: var(--black);
        }

        .stat-card.highlighted {
            border-color: var(--yellow);
            border-width: 3px;
        }

        .stat-card-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--light-gray);
            margin-bottom: 0.25rem;
        }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--white);
            line-height: 1.2;
        }

        .stat-card.highlighted .stat-card-value {
            color: var(--yellow);
        }

        .stat-card-unit {
            font-size: 0.75rem;
            color: var(--light-gray);
            font-weight: 600;
            margin-top: 0.15rem;
        }

        /* ===== MACRO VISUAL DISPLAY ===== */
        .macro-calories-hero {
            text-align: center;
            padding: 2rem 0 1.5rem;
            border-bottom: 1px solid var(--medium-gray);
            margin-bottom: 2rem;
        }

        .macro-calories-number {
            font-size: clamp(3.5rem, 8vw, 5rem);
            font-weight: 900;
            color: var(--yellow);
            line-height: 1;
            letter-spacing: -2px;
        }

        .macro-calories-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--light-gray);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 0.5rem;
        }

        .macro-visual-row {
            display: flex;
            align-items: center;
            gap: 3rem;
        }

        .macro-chart-wrap {
            width: 220px;
            height: 220px;
            flex-shrink: 0;
            position: relative;
        }

        .macro-legend {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .macro-legend-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--black);
            border: 1px solid var(--medium-gray);
            transition: border-color 0.3s ease;
        }

        .macro-legend-item:hover {
            border-color: var(--yellow);
        }

        .macro-legend-dot {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .macro-legend-detail {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .macro-legend-name {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--light-gray);
            width: 70px;
        }

        .macro-legend-value {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--white);
        }

        .macro-legend-pct {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--light-gray);
            margin-left: auto;
        }

        /* ===== AUTH CONTAINER ===== */
        .auth-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 3rem;
            background: var(--dark-gray);
            border: 2px solid var(--medium-gray);
        }

        .auth-container h2 {
            font-size: 1.5rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .auth-container p.auth-subtitle {
            color: var(--light-gray);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .auth-container .form-group {
            margin-bottom: 1.5rem;
        }

        .auth-container label {
            display: block;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            color: var(--white);
        }

        .auth-container input[type="email"],
        .auth-container input[type="password"] {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--black);
            border: 2px solid var(--medium-gray);
            border-radius: 0;
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            transition: border-color 0.3s ease;
        }

        .auth-container input:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .auth-container .btn-primary {
            width: 100%;
            margin-top: 0.5rem;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--light-gray);
            font-size: 0.9rem;
        }

        .auth-toggle a {
            color: var(--yellow);
            text-decoration: underline;
            font-weight: 700;
            cursor: pointer;
        }

        .auth-error {
            color: #ff4444;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            text-align: center;
            display: none;
        }

        /* ===== USER BAR ===== */
        .user-bar {
            background: var(--dark-gray);
            border-bottom: 1px solid var(--medium-gray);
            padding: 0.75rem 4rem;
            padding-top: calc(0.75rem + 80px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-bar-email {
            color: var(--light-gray);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .user-bar-email i {
            color: var(--yellow);
            margin-right: 0.5rem;
        }

        .user-bar button {
            background: transparent;
            border: 1px solid var(--medium-gray);
            color: var(--light-gray);
            padding: 0.4rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-bar button:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        /* ===== SUBSCRIPTION STATUS CARD ===== */
        .sub-status-bar {
            padding: 1.5rem 4rem;
            background: var(--black);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .sub-status-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .sub-status-tier {
            font-weight: 900;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--yellow);
        }

        .sub-status-detail {
            font-size: 0.85rem;
            color: var(--light-gray);
            font-weight: 600;
        }

        .sub-status-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .sub-status-actions a {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.4rem 1rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .sub-manage-link {
            color: var(--light-gray);
            border: 1px solid var(--medium-gray);
        }

        .sub-manage-link:hover {
            color: var(--yellow);
            border-color: var(--yellow);
        }

        .sub-upgrade-link {
            color: var(--black);
            background: var(--yellow);
            border: 1px solid var(--yellow);
        }

        .sub-upgrade-link:hover {
            color: var(--yellow);
            background: transparent;
        }

        .sub-no-plan {
            padding: 2rem 4rem;
            background: var(--dark-gray);
            border-bottom: 1px solid var(--medium-gray);
            text-align: center;
        }

        .sub-no-plan p {
            color: var(--light-gray);
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .sub-no-plan a {
            color: var(--yellow);
            font-weight: 700;
            text-decoration: underline;
        }

        /* ===== COACHING CALL BANNER ===== */
        .coaching-call-banner {
            padding: 1.5rem 4rem;
            background: rgba(39, 174, 96, 0.1);
            border-bottom: 1px solid #27AE60;
            text-align: center;
        }

        .coaching-call-banner p {
            color: var(--white);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
        }

        .coaching-call-banner a {
            color: #27AE60;
            font-weight: 700;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .sub-status-bar {
                padding: 1rem 1.5rem;
                flex-direction: column;
                align-items: flex-start;
            }
            .sub-no-plan {
                padding: 1.5rem 1.5rem;
            }
            .coaching-call-banner {
                padding: 1rem 1.5rem;
            }
        }

        /* ===== PHASE BANNER ===== */
        .phase-banner {
            padding: 2.5rem 4rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .phase-banner-label {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
        }

        .phase-banner-dates {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            opacity: 0.9;
        }

        .phase-banner-countdown {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
        }

        .phase-progress-bar {
            max-width: 500px;
            margin: 0 auto;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .phase-progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            transition: width 0.6s ease;
        }

        /* ===== DASHBOARD HERO ===== */
        .dash-hero {
            padding-top: 80px;
            min-height: 40vh;
            display: flex;
            align-items: center;
            position: relative;
            background: var(--black);
        }

        .dash-hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.4;
            z-index: 0;
        }

        .dash-hero-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 3rem 4rem;
            position: relative;
            z-index: 1;
        }

        .dash-hero-content { max-width: 800px; }

        .dash-hero-subtitle {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
        }

        .dash-hero-content h1 {
            font-weight: 900;
            font-size: clamp(2rem, 5vw, 3.5rem);
            line-height: 1.1;
            text-transform: uppercase;
        }

        /* ===== DASHBOARD GRID ===== */
        .dash-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
        }

        .dash-card {
            background: var(--dark-gray);
            border: 2px solid var(--medium-gray);
            padding: 2.5rem;
            margin-bottom: 2rem;
        }

        .dash-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .dash-card-title {
            font-size: 1.3rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dash-card-title i {
            color: var(--yellow);
            margin-right: 0.75rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--light-gray);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--medium-gray);
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }

        /* ===== COLLAPSIBLE FORM ===== */
        .collapsible-toggle {
            background: transparent;
            border: 2px solid var(--yellow);
            color: var(--yellow);
            padding: 0.75rem 1.5rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .collapsible-toggle:hover {
            background: var(--yellow);
            color: var(--black);
        }

        .collapsible-toggle i {
            transition: transform 0.3s ease;
        }

        .collapsible-toggle.open i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--medium-gray);
        }

        .collapsible-content.open {
            display: block;
        }

        /* ===== INLINE FORM ===== */
        .dash-form {
            max-width: 600px;
        }

        .dash-form .form-group {
            margin-bottom: 1rem;
        }

        .dash-form label {
            display: block;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            color: var(--white);
        }

        .dash-form input[type="number"],
        .dash-form input[type="date"],
        .dash-form input[type="text"],
        .dash-form select,
        .dash-form textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--black);
            border: 2px solid var(--medium-gray);
            border-radius: 0;
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            transition: border-color 0.3s ease;
            -moz-appearance: textfield;
        }

        .dash-form input[type="date"] {
            color-scheme: dark;
            -webkit-appearance: none;
            appearance: none;
            min-height: 48px;
        }

        .dash-form input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
        }

        .dash-form input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        .dash-form input:focus,
        .dash-form select:focus,
        .dash-form textarea:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .dash-form input[type="number"]::-webkit-outer-spin-button,
        .dash-form input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .dash-form select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23cccccc' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .dash-form select option {
            background: var(--dark-gray);
            color: var(--white);
        }

        .dash-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .dash-form .btn-primary {
            padding: 0.85rem 2rem;
            font-size: 0.9rem;
        }

        .form-error {
            color: #ff4444;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .form-success {
            color: var(--phase-build);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        /* ===== WEIGHT CHART ===== */
        .weight-chart-container {
            margin-top: 1rem;
            position: relative;
            height: 300px;
        }

        /* ===== WEIGHT HISTORY ===== */
        .weight-history {
            margin-top: 1.5rem;
        }

        .weight-history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .weight-history-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 0.9rem;
        }

        .weight-history-row:last-child {
            border-bottom: none;
        }

        .weight-history-date {
            width: 110px;
            flex-shrink: 0;
            color: var(--light-gray);
        }

        .weight-history-weight {
            width: 80px;
            flex-shrink: 0;
            font-weight: 700;
            color: var(--yellow);
        }

        .weight-history-notes {
            flex: 1;
            color: var(--light-gray);
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .weight-history-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .weight-history-actions button {
            background: transparent;
            border: 1px solid var(--medium-gray);
            color: var(--light-gray);
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .weight-history-actions button:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .weight-history-actions button.delete-btn:hover {
            border-color: var(--phase-cut);
            color: var(--phase-cut);
        }

        .weight-history-row input {
            background: var(--medium-gray);
            border: 1px solid var(--light-gray);
            color: var(--white);
            padding: 0.4rem 0.5rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
        }

        .weight-history-row input[type="date"] {
            width: 130px;
        }

        .weight-history-row input[type="number"] {
            width: 80px;
        }

        .weight-history-row input[type="text"] {
            flex: 1;
            min-width: 0;
        }

        .weight-history-empty {
            color: var(--light-gray);
            font-size: 0.9rem;
            padding: 1rem 0;
            text-align: center;
        }

        /* ===== BODY COMP ===== */
        .body-comp-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .body-comp-item {
            background: var(--black);
            border: 1px solid var(--medium-gray);
            padding: 0.75rem;
            text-align: center;
        }

        .body-comp-item .label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--light-gray);
            margin-bottom: 0.15rem;
        }

        .body-comp-item .value {
            font-size: 1.2rem;
            font-weight: 900;
        }

        /* ===== CHECKLIST INTERACTIVE ===== */
        .checklist-interactive {
            max-width: 700px;
        }

        .checklist-interactive .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .checklist-interactive .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-checkbox {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            border: 2px solid var(--yellow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2px;
            background: transparent;
        }

        .checklist-checkbox.checked {
            background: var(--yellow);
        }

        .checklist-checkbox.checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--black);
            font-size: 0.85rem;
        }

        .checklist-interactive .checklist-text {
            color: var(--light-gray);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .checklist-interactive .checklist-item.checked .checklist-text {
            text-decoration: line-through;
            opacity: 0.5;
        }

        /* ===== YEAR-OVER-YEAR ===== */
        .yoy-timeline {
            max-width: 800px;
        }

        .yoy-year {
            margin-bottom: 2.5rem;
        }

        .yoy-year-label {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            color: var(--yellow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .yoy-badge {
            background: var(--yellow);
            color: var(--black);
            font-size: 0.65rem;
            font-weight: 900;
            padding: 0.25rem 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .yoy-phases {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .yoy-phase-card {
            background: var(--black);
            border: 1px solid var(--medium-gray);
            padding: 1.25rem;
        }

        .yoy-phase-name {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .yoy-phase-dates {
            font-size: 0.8rem;
            color: var(--light-gray);
            margin-bottom: 0.5rem;
        }

        .yoy-phase-weight {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .yoy-phase-change {
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        .yoy-phase-change.loss { color: var(--phase-cut); }
        .yoy-phase-change.gain { color: var(--phase-build); }
        .yoy-phase-change.neutral { color: var(--phase-maintain); }

        .yoy-ytd-summary {
            border: 1px solid var(--medium-gray);
            padding: 1.5rem;
            background: var(--black);
        }

        .yoy-ytd-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.25rem;
        }

        .yoy-ytd-stat {
            text-align: center;
        }

        .yoy-ytd-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--light-gray);
            margin-bottom: 0.4rem;
        }

        .yoy-ytd-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--white);
        }

        .yoy-ytd-value.loss { color: var(--phase-cut); }
        .yoy-ytd-value.gain { color: var(--phase-build); }
        .yoy-ytd-value.neutral { color: var(--phase-maintain); }

        .yoy-ytd-date {
            font-size: 0.75rem;
            color: var(--light-gray);
            margin-top: 0.25rem;
        }

        .yoy-ytd-phase {
            font-size: 0.85rem;
            color: var(--light-gray);
            text-align: center;
            padding-top: 1.25rem;
            border-top: 1px solid var(--medium-gray);
        }

        /* ===== QUICK LINKS ===== */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* ===== CTA SECTION ===== */
        .cta-section {
            background: var(--dark-gray);
            padding: 8rem 4rem;
            text-align: center;
            width: 100%;
        }

        .cta-title {
            font-weight: 900;
            font-size: clamp(2.5rem, 5vw, 4.5rem);
            margin-bottom: 1.5rem;
            text-transform: uppercase;
        }

        .cta-subtitle {
            font-size: 1.2rem;
            color: var(--light-gray);
            margin-bottom: 3rem;
        }

        /* ===== MAP ===== */
        .map-section { width: 100%; }

        .map-section iframe {
            width: 100%;
            height: 400px;
            border: none;
            display: block;
        }

        /* ===== FOOTER ===== */
        footer {
            padding: 4rem 0 2rem;
            background: var(--black);
            border-top: 1px solid var(--medium-gray);
            width: 100%;
        }

        .footer-container {
            max-width: 100%;
            margin: 0;
            padding: 0 4rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 4rem;
            margin-bottom: 3rem;
        }

        .footer-section h3 {
            font-weight: 900;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .footer-section ul { list-style: none; }
        .footer-section ul li { margin-bottom: 0.75rem; }

        .footer-section a {
            color: var(--light-gray);
            text-decoration: none;
            transition: color 0.3s ease;
            font-weight: 500;
        }

        .footer-section a:hover { color: var(--yellow); }

        .footer-logo {
            height: 60px;
            margin-bottom: 1.5rem;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid var(--medium-gray);
            color: var(--light-gray);
            font-size: 0.9rem;
        }

        /* ===== HAMBURGER / MOBILE NAV ===== */
        .hamburger {
            display: none;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            z-index: 1002;
        }

        .hamburger span {
            display: block;
            width: 30px;
            height: 3px;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.97);
            z-index: 1001;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .mobile-nav-overlay.active { display: flex; }

        .mobile-nav-overlay a {
            color: var(--white);
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 1rem 2rem;
            transition: color 0.3s ease;
            text-align: center;
        }

        .mobile-nav-overlay .mobile-sub-link { font-size: 0.9rem; color: var(--light-gray); padding: 0.5rem 2rem; font-weight: 700; letter-spacing: 0.5px; }
        .mobile-nav-overlay .mobile-sub-link:hover { color: var(--yellow); }
        .mobile-nav-overlay a:hover { color: var(--yellow); }

        .mobile-nav-overlay .mobile-cta {
            margin-top: 1.5rem;
            background: var(--yellow);
            color: var(--black);
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--yellow);
            transition: all 0.3s ease;
        }

        .mobile-nav-overlay .mobile-cta:hover {
            background: transparent;
            color: var(--yellow);
        }

        .mobile-nav-overlay .mobile-login {
            margin-top: 0.75rem;
            color: var(--yellow);
            border: 2px solid var(--yellow);
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            background: transparent;
        }

        .mobile-nav-overlay .mobile-login:hover {
            background: var(--yellow);
            color: var(--black);
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-container {
            background: #1a1a1a;
            border: 2px solid var(--medium-gray);
            max-width: 700px;
            width: 100%;
            position: relative;
            margin: auto;
            animation: modalSlideIn 0.3s ease-out;
            padding: 2.5rem;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: none;
            color: var(--light-gray);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0.5rem;
            transition: color 0.3s ease;
            font-weight: 300;
            z-index: 10000;
        }

        .modal-close:hover { color: var(--yellow); }

        .modal-container h3 {
            font-size: 1.3rem;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
        }

        .modal-container iframe {
            width: 100%;
            border: none;
            display: block;
        }

        /* ===== CALC MODAL FORM ===== */
        .calc-gender-options,
        .calc-goal-options {
            display: flex;
            gap: 1rem;
        }

        .calc-gender-option,
        .calc-goal-option {
            flex: 1;
        }

        .calc-gender-option input[type="radio"],
        .calc-goal-option input[type="radio"] {
            display: none;
        }

        .calc-gender-option label,
        .calc-goal-option label {
            display: block;
            text-align: center;
            padding: 0.75rem 1rem;
            border: 2px solid var(--medium-gray);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            color: var(--light-gray);
        }

        .calc-gender-option input:checked + label,
        .calc-goal-option input:checked + label {
            border-color: var(--yellow);
            color: var(--yellow);
            background: rgba(255, 210, 2, 0.1);
        }

        .calc-height-inputs {
            display: flex;
            gap: 1rem;
        }

        .calc-height-field {
            flex: 1;
            position: relative;
        }

        .calc-height-field input {
            width: 100%;
            padding: 0.85rem 2.5rem 0.85rem 1rem;
            background: var(--black);
            border: 2px solid var(--medium-gray);
            border-radius: 0;
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            -moz-appearance: textfield;
        }

        .calc-height-field input::-webkit-outer-spin-button,
        .calc-height-field input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .calc-height-field input:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .calc-height-unit {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-gray);
            font-size: 0.85rem;
            font-weight: 600;
            pointer-events: none;
        }

        .calc-results {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .calc-result-card {
            background: var(--black);
            border: 1px solid var(--medium-gray);
            padding: 1rem;
            text-align: center;
        }

        .calc-result-card.highlighted {
            border-color: var(--yellow);
            border-width: 2px;
        }

        .calc-result-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--light-gray);
            margin-bottom: 0.25rem;
        }

        .calc-result-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--white);
        }

        .calc-result-unit {
            font-size: 0.7rem;
            color: var(--light-gray);
        }

        @media (max-width: 600px) {
            .calc-results {
                grid-template-columns: repeat(2, 1fr);
            }
            .calc-goal-options {
                flex-direction: column;
            }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== PHASE TRANSITION CARD ===== */
        .transition-card {
            background: var(--dark-gray);
            border: 2px solid var(--medium-gray);
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .transition-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--yellow);
        }

        .transition-card-badge {
            display: inline-block;
            background: var(--yellow);
            color: var(--black);
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 0.4rem 1rem;
            margin-bottom: 1.25rem;
        }

        .transition-card h3 {
            font-size: 1.3rem;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .transition-card p {
            color: var(--light-gray);
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        .transition-changes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .transition-change-item {
            background: var(--black);
            padding: 1.25rem;
            border: 1px solid var(--medium-gray);
        }

        .transition-change-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--light-gray);
            margin-bottom: 0.5rem;
        }

        .transition-change-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--white);
        }

        .transition-cta {
            background: rgba(255, 210, 2, 0.08);
            border: 1px solid rgba(255, 210, 2, 0.2);
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .transition-cta p {
            color: var(--light-gray);
            margin: 0;
            font-size: 0.9rem;
        }

        .transition-cta .btn-primary {
            white-space: nowrap;
            padding: 0.8rem 1.5rem;
            font-size: 0.8rem;
        }

        /* ===== WEEKLY CHECK-IN ===== */
        .checkin-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .checkin-form-grid .form-group {
            margin-bottom: 0;
        }

        .checkin-form-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        .checkin-rating {
            display: flex;
            gap: 0.5rem;
        }

        .checkin-rating label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border: 2px solid var(--medium-gray);
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            color: var(--light-gray);
            transition: all 0.2s ease;
        }

        .checkin-rating input { display: none; }

        .checkin-rating input:checked + label {
            border-color: var(--yellow);
            background: var(--yellow);
            color: var(--black);
        }

        .checkin-rating label:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .checkin-history {
            margin-top: 2rem;
        }

        .checkin-entry {
            background: var(--black);
            border: 1px solid var(--medium-gray);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .checkin-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .checkin-entry-date {
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checkin-entry-phase {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.25rem 0.75rem;
            border: 1px solid;
        }

        .checkin-entry-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .checkin-entry-stat {
            font-size: 0.85rem;
            color: var(--light-gray);
        }

        .checkin-entry-stat strong {
            color: var(--white);
        }

        .checkin-entry-notes {
            font-size: 0.85rem;
            color: var(--light-gray);
            font-style: italic;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--medium-gray);
        }

        .coaching-upsell {
            background: linear-gradient(135deg, rgba(255, 210, 2, 0.08) 0%, rgba(255, 210, 2, 0.02) 100%);
            border: 1px solid rgba(255, 210, 2, 0.2);
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }

        .coaching-upsell h4 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
        }

        .coaching-upsell p {
            color: var(--light-gray);
            font-size: 0.9rem;
            margin-bottom: 1.25rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .coaching-upsell .btn-primary {
            padding: 0.8rem 2rem;
            font-size: 0.8rem;
        }

        /* ===== DOWNLOADS GRID ===== */
        .downloads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .download-card {
            background: var(--black);
            border: 2px solid var(--medium-gray);
            padding: 2rem 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--white);
            display: block;
        }

        .download-card:hover {
            border-color: var(--yellow);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 210, 2, 0.15);
        }

        .download-card i {
            font-size: 2rem;
            color: var(--yellow);
            margin-bottom: 1rem;
            display: block;
        }

        .download-card h4 {
            font-size: 0.85rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .download-card p {
            font-size: 0.8rem;
            color: var(--light-gray);
            line-height: 1.5;
        }

        .download-card.coming-soon {
            opacity: 0.5;
            pointer-events: none;
        }

        .download-card .coming-soon-badge {
            display: inline-block;
            background: var(--medium-gray);
            color: var(--light-gray);
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.2rem 0.6rem;
            margin-top: 0.75rem;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .nav-container,
            .hero-container,
            .section-container,
            .footer-container {
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .cta-section {
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .blueprint-subnav-container {
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .user-bar {
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .dash-hero-container {
                padding-left: 2rem;
                padding-right: 2rem;
            }

            .phase-banner {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }

        @media (max-width: 768px) {
            .hamburger { display: flex !important; }
            .nav-links { display: none !important; }
            .nav-cta-group .login-btn { display: none; }

            .nav-container {
                padding: 0 1.5rem;
                flex-wrap: wrap;
            }

            .nav-cta-group {
                order: 3;
                width: 100%;
            }

            .cta-btn {
                order: 3;
                width: 100%;
                text-align: center;
                margin-top: 0.75rem;
                padding: 0.7rem 1rem;
                font-size: 0.8rem;
            }

            .hero { padding-top: 130px; }
            .hero-container { padding: 2rem 1.5rem; }
            .hero-content h1 { font-size: clamp(2rem, 6vw, 3rem); }
            .hero-content p { font-size: 1.1rem; margin-bottom: 2rem; }

            .dash-hero { padding-top: 130px; min-height: 30vh; }
            .dash-hero-container { padding: 2rem 1.5rem; }
            .dash-hero-content h1 { font-size: clamp(1.8rem, 5vw, 2.5rem); }

            .section-container { padding: 0 1.5rem; }
            .section-title { font-size: clamp(1.8rem, 5vw, 2.5rem); }
            .section-header { margin-bottom: 2rem; }
            .section { padding: 4rem 0; }

            .features-grid { grid-template-columns: 1fr; }

            .blueprint-subnav-container {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }

            .cta-section { padding: 4rem 1.5rem; }
            .cta-title { font-size: clamp(1.8rem, 5vw, 2.5rem); }

            .map-section iframe { height: 250px; }

            .footer-container {
                padding: 0 1.5rem;
                gap: 2rem;
            }

            .btn-primary, .btn-outline {
                padding: 0.8rem 1.5rem;
                font-size: 0.8rem;
                white-space: normal;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-row-3 {
                grid-template-columns: repeat(3, 1fr);
            }

            .stat-card {
                padding: 0.75rem 0.5rem;
            }

            .stat-card-value {
                font-size: 1.5rem;
            }

            .stat-card-label {
                font-size: 0.6rem;
                letter-spacing: 0.5px;
            }

            .stat-card-unit {
                font-size: 0.65rem;
            }

            .user-bar {
                padding: 0.75rem 1.5rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .phase-banner {
                padding: 2rem 1.5rem;
            }

            .dash-card {
                padding: 1.5rem;
            }

            .macro-visual-row {
                flex-direction: column;
                gap: 2rem;
            }

            .macro-chart-wrap {
                width: 180px;
                height: 180px;
                margin: 0 auto;
            }

            .macro-legend {
                width: 100%;
            }

            .macro-legend-detail {
                flex-wrap: wrap;
            }

            .macro-legend-name {
                width: 60px;
            }

            .form-row {
                flex-direction: column;
            }

            .weight-chart-container {
                height: 220px;
            }

            .body-comp-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.4rem;
            }

            .body-comp-item {
                padding: 0.5rem;
            }

            .body-comp-item .value {
                font-size: 1rem;
            }

            .yoy-phases {
                grid-template-columns: 1fr;
            }

            .weight-history-row {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 1rem 0;
            }

            .weight-history-date {
                width: auto;
                flex: 1;
                font-size: 0.8rem;
            }

            .weight-history-weight {
                width: auto;
                font-size: 0.85rem;
            }

            .weight-history-actions {
                margin-left: auto;
            }

            .weight-history-notes {
                flex-basis: 100%;
                white-space: normal;
                font-size: 0.8rem;
                order: 4;
            }

            .weight-history-row input[type="date"] {
                width: 100%;
                flex: 1;
            }

            .weight-history-row input[type="number"] {
                width: 70px;
            }

            .weight-history-row input[type="text"] {
                flex-basis: 100%;
                order: 4;
            }

            .modal-overlay { padding: 1rem; }
            .modal-container {
                max-width: calc(100% - 2rem);
                padding: 1.5rem;
            }

            .transition-changes {
                grid-template-columns: 1fr;
            }

            .transition-cta {
                flex-direction: column;
                text-align: center;
            }

            .checkin-form-grid {
                grid-template-columns: 1fr;
            }

            .checkin-entry-stats {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .downloads-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-row-3 {
                grid-template-columns: repeat(3, 1fr);
            }

            .body-comp-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== COACH VIEW TOGGLE ===== */
        .coach-toggle-btn {
            background: transparent;
            border: 2px solid var(--yellow);
            color: var(--yellow);
            padding: 0.4rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }

        .coach-toggle-btn:hover,
        .coach-toggle-btn.active {
            background: var(--yellow);
            color: var(--black);
        }

        .user-bar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-bar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* ===== NOTIFICATION BELL ===== */
        .notification-bell {
            position: relative;
            background: transparent;
            border: 1px solid var(--medium-gray);
            color: var(--light-gray);
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--phase-cut);
            color: var(--white);
            font-size: 0.6rem;
            font-weight: 900;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .notification-panel {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--dark-gray);
            border: 2px solid var(--medium-gray);
            width: 360px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 0.5rem;
        }

        .notification-panel.active {
            display: block;
        }

        .notification-panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 0.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-panel-header a {
            font-size: 0.7rem;
            color: var(--yellow);
            cursor: pointer;
            text-decoration: none;
            font-weight: 700;
        }

        .notification-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(51, 51, 51, 0.5);
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255, 210, 2, 0.05);
        }

        .notification-item.unread {
            border-left: 3px solid var(--yellow);
        }

        .notification-item-title {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .notification-item-message {
            font-size: 0.8rem;
            color: var(--light-gray);
            line-height: 1.5;
        }

        .notification-item-time {
            font-size: 0.7rem;
            color: var(--light-gray);
            margin-top: 0.35rem;
            opacity: 0.7;
        }

        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: var(--light-gray);
            font-size: 0.85rem;
        }

        /* ===== MACRO CHANGE BANNER ===== */
        .macro-change-banner {
            background: rgba(255, 210, 2, 0.08);
            border: 2px solid rgba(255, 210, 2, 0.3);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .macro-change-banner.active {
            display: block;
        }

        .macro-change-banner-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .macro-change-banner-header i {
            color: var(--yellow);
            font-size: 1.1rem;
        }

        .macro-change-banner-header span {
            font-size: 0.9rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .macro-change-values {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .macro-change-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
        }

        .macro-change-item .label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--light-gray);
        }

        .macro-change-item .values {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .macro-change-item .values .old {
            color: var(--light-gray);
            text-decoration: line-through;
            margin-right: 0.35rem;
        }

        .macro-change-item .values .new {
            color: var(--yellow);
        }

        .macro-change-note {
            font-size: 0.85rem;
            color: var(--light-gray);
            font-style: italic;
            margin-bottom: 0.75rem;
        }

        .macro-change-dismiss {
            background: transparent;
            border: 1px solid var(--yellow);
            color: var(--yellow);
            padding: 0.4rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .macro-change-dismiss:hover {
            background: var(--yellow);
            color: var(--black);
        }

        /* ===== COACH VIEW CONTAINER ===== */
        .coach-view-container {
            display: none;
        }

        .coach-view-container.active {
            display: block;
        }

        .coach-hero {
            padding: 3rem 4rem;
            background: var(--dark-gray);
            border-bottom: 1px solid var(--medium-gray);
        }

        .coach-hero h2 {
            font-size: 1.5rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .coach-hero p {
            color: var(--light-gray);
            font-size: 0.95rem;
        }

        .coach-stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .coach-stat {
            padding: 1.25rem 2rem;
            text-align: center;
            border-right: 1px solid var(--medium-gray);
        }

        .coach-stat:last-child {
            border-right: none;
        }

        .coach-stat-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--yellow);
        }

        .coach-stat-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--light-gray);
            margin-top: 0.25rem;
        }

        .coach-stat.attention .coach-stat-value {
            color: var(--phase-cut);
        }

        .coach-actions-bar {
            padding: 1.25rem 4rem;
            background: var(--black);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .coach-actions-bar .btn-primary {
            padding: 0.6rem 1.25rem;
            font-size: 0.75rem;
        }

        /* ===== CLIENT CARD GRID ===== */
        .client-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 2rem 4rem;
        }

        .client-card {
            background: var(--dark-gray);
            border: 2px solid var(--medium-gray);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .client-card:hover {
            border-color: var(--yellow);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 210, 2, 0.15);
        }

        .client-card.needs-attention {
            border-left: 4px solid var(--phase-cut);
        }

        .client-card-name {
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .client-card-email {
            font-size: 0.8rem;
            color: var(--light-gray);
            margin-bottom: 1rem;
        }

        .client-card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .client-card-stat {
            text-align: center;
            padding: 0.5rem;
            background: var(--black);
        }

        .client-card-stat .label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--light-gray);
        }

        .client-card-stat .value {
            font-size: 1rem;
            font-weight: 900;
            color: var(--white);
        }

        .client-card-last-checkin {
            font-size: 0.75rem;
            color: var(--light-gray);
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .client-card-last-checkin i {
            font-size: 0.65rem;
        }

        .client-card-last-checkin.stale {
            color: var(--phase-cut);
        }

        .coach-empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--light-gray);
        }

        .coach-empty-state i {
            font-size: 3rem;
            color: var(--medium-gray);
            margin-bottom: 1rem;
            display: block;
        }

        .coach-empty-state p {
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }

        /* ===== COACH DRILL-DOWN ===== */
        .coach-drilldown {
            display: none;
        }

        .coach-drilldown.active {
            display: block;
        }

        .coach-drilldown-header {
            padding: 1.5rem 4rem;
            background: var(--dark-gray);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .coach-drilldown-back {
            background: transparent;
            border: 1px solid var(--medium-gray);
            color: var(--light-gray);
            padding: 0.5rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .coach-drilldown-back:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .coach-drilldown-name {
            font-size: 1.3rem;
            font-weight: 900;
            text-transform: uppercase;
        }

        .coach-drilldown-toolbar {
            padding: 1rem 4rem;
            background: var(--black);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .coach-action-btn {
            background: transparent;
            border: 1px solid var(--medium-gray);
            color: var(--light-gray);
            padding: 0.5rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .coach-action-btn:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .coach-action-btn.danger:hover {
            border-color: var(--phase-cut);
            color: var(--phase-cut);
        }

        /* ===== COACH NOTES LIST ===== */
        .coach-notes-section {
            margin-top: 2rem;
        }

        .coach-note-entry {
            padding: 1rem 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .coach-note-entry:last-child {
            border-bottom: none;
        }

        .coach-note-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .coach-note-date {
            font-size: 0.75rem;
            color: var(--light-gray);
        }

        .coach-note-category {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.2rem 0.5rem;
            background: var(--medium-gray);
            color: var(--light-gray);
        }

        .coach-note-text {
            font-size: 0.9rem;
            color: var(--white);
            line-height: 1.6;
        }

        /* ===== MACRO CHANGE LOG ===== */
        .macro-log-entry {
            padding: 1rem 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .macro-log-entry:last-child {
            border-bottom: none;
        }

        .macro-log-date {
            font-size: 0.75rem;
            color: var(--light-gray);
            margin-bottom: 0.5rem;
        }

        .macro-log-values {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .macro-log-values span {
            color: var(--light-gray);
        }

        .macro-log-values strong {
            color: var(--yellow);
        }

        .macro-log-note {
            font-size: 0.8rem;
            color: var(--light-gray);
            font-style: italic;
            margin-top: 0.35rem;
        }

        /* ===== CLAIM MODAL ===== */
        .claim-athlete-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .claim-athlete-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .claim-athlete-row:last-child {
            border-bottom: none;
        }

        .claim-athlete-info {
            flex: 1;
        }

        .claim-athlete-name {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .claim-athlete-email {
            font-size: 0.8rem;
            color: var(--light-gray);
        }

        .claim-badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.25rem 0.75rem;
        }

        .claim-badge.yours {
            background: var(--yellow);
            color: var(--black);
        }

        .claim-badge.assigned {
            background: var(--medium-gray);
            color: var(--light-gray);
        }

        .claim-btn {
            background: transparent;
            border: 1px solid var(--yellow);
            color: var(--yellow);
            padding: 0.35rem 0.75rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .claim-btn:hover {
            background: var(--yellow);
            color: var(--black);
        }

        /* ===== COACH LOADING STATE ===== */
        .coach-loading {
            text-align: center;
            padding: 3rem;
            color: var(--light-gray);
        }

        .coach-loading i {
            font-size: 2rem;
            color: var(--yellow);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
            display: block;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ===== COACH RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .coach-hero { padding: 2rem; }
            .coach-actions-bar { padding: 1rem 2rem; }
            .client-card-grid { padding: 1.5rem 2rem; }
            .coach-drilldown-header { padding: 1rem 2rem; }
            .coach-drilldown-toolbar { padding: 0.75rem 2rem; }
        }

        @media (max-width: 768px) {
            .coach-hero { padding: 1.5rem; }
            .coach-stats-bar { grid-template-columns: 1fr; }
            .coach-stat { border-right: none; border-bottom: 1px solid var(--medium-gray); padding: 0.75rem 1rem; }
            .coach-stat:last-child { border-bottom: none; }
            .coach-actions-bar { padding: 0.75rem 1.5rem; flex-wrap: wrap; }
            .client-card-grid { padding: 1rem 1.5rem; grid-template-columns: 1fr; }
            .coach-drilldown-header { padding: 1rem 1.5rem; }
            .coach-drilldown-toolbar { padding: 0.75rem 1.5rem; gap: 0.5rem; }
            .macro-change-values { grid-template-columns: repeat(2, 1fr); }
            .notification-panel { width: 300px; right: -1rem; }
        }

        @media (max-width: 480px) {
            .notification-panel { width: calc(100vw - 2rem); right: -3rem; }
            .coach-drilldown-name { font-size: 1rem; }
            .client-card-stats { grid-template-columns: 1fr; }
        }

        /* ===== ACCOUNT MODAL ===== */
        .account-modal-body {
            max-width: 500px;
        }

        .account-field-readonly {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--medium-gray);
            border: 2px solid var(--medium-gray);
            color: var(--light-gray);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: not-allowed;
        }

        .account-role-badge {
            display: inline-block;
            padding: 0.35rem 1rem;
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--yellow);
            color: var(--yellow);
            background: transparent;
        }

        .account-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--medium-gray);
        }

        .account-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .account-section h4 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            color: var(--yellow);
        }

        .account-btn-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .account-msg {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .account-msg.error { color: #ff4444; }
        .account-msg.success { color: var(--phase-build); }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <img src="images/logo.png" alt="Black Iron Athletics">
                </a>
            </div>
            <ul class="nav-links">
                <li class="has-submenu">
                    <a href="about.html">About Us</a>
                    <ul class="submenu">
                        <li><a href="about.html#mission">Our Mission</a></li>
                        <li><a href="about.html#team">Meet the Team</a></li>
                        <li><a href="programs.html">Programs</a></li>
                        <li><a href="schedule.html">Class Schedule</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="getting-started.html">Getting Started</a>
                    <ul class="submenu">
                        <li><a href="getting-started.html#membership">Membership Options</a></li>
                        <li><a href="getting-started.html#faqs">FAQs</a></li>
                    </ul>
                </li>
                <li><a href="media.html">Media</a></li>
                <li><a href="blog/">Blog</a></li>
                <li class="has-submenu">
                    <a href="blueprint.html">Nutrition</a>
                    <ul class="submenu">
                        <li><a href="blueprint.html">4-Phase Blueprint</a></li>
                    </ul>
                </li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
            <div class="nav-cta-group">
                <a href="blueprint-dashboard.html" class="login-btn">My Dashboard</a>
                <a href="#" onclick="openLeadModal(); return false;" class="cta-btn">Book Free Consultation</a>
            </div>
            <button class="hamburger" onclick="toggleMobileNav()" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="mobile-nav-overlay" id="mobileNav">
        <a href="index.html" onclick="closeMobileNav()">Home</a>
        <a href="about.html" onclick="closeMobileNav()">About Us</a>
        <a href="about.html#mission" class="mobile-sub-link" onclick="closeMobileNav()">Our Mission</a>
        <a href="about.html#team" class="mobile-sub-link" onclick="closeMobileNav()">Meet the Team</a>
        <a href="programs.html" class="mobile-sub-link" onclick="closeMobileNav()">Programs</a>
        <a href="schedule.html" class="mobile-sub-link" onclick="closeMobileNav()">Class Schedule</a>
        <a href="getting-started.html" onclick="closeMobileNav()">Getting Started</a>
        <a href="getting-started.html#membership" class="mobile-sub-link" onclick="closeMobileNav()">Membership Options</a>
        <a href="getting-started.html#faqs" class="mobile-sub-link" onclick="closeMobileNav()">FAQs</a>
        <a href="media.html" onclick="closeMobileNav()">Media</a>
        <a href="blog/" onclick="closeMobileNav()">Blog</a>
        <a href="blueprint.html" onclick="closeMobileNav()">Nutrition</a>
        <a href="blueprint.html" class="mobile-sub-link" onclick="closeMobileNav()">4-Phase Blueprint</a>
        <a href="contact.html" onclick="closeMobileNav()">Contact</a>
        <a href="#" class="mobile-cta" onclick="closeMobileNav(); openLeadModal(); return false;">Book Free Consultation</a>
        <a href="blueprint-dashboard.html" class="mobile-login" onclick="closeMobileNav()">My Dashboard</a>
    </div>

    <!-- Hero Section (shown when NOT logged in) -->
    <section class="hero" id="authHero">
        <img src="images/hero-blueprint-how-to-use.webp" alt="Athlete Dashboard" class="hero-bg" fetchpriority="high">
        <div class="hero-container">
            <div class="hero-content">
                <div class="hero-subtitle">Athlete Dashboard</div>
                <h1>Your Blueprint Command Center</h1>
                <p>Track your macros, log your weight, monitor body composition, and follow your phase progress &mdash; all in one place.</p>
            </div>
        </div>
    </section>

    <!-- Auth Section (shown when NOT logged in) -->
    <section class="section section-alt" id="authSection">
        <div class="section-container">
            <div class="auth-container">
                <h2 id="authTitle">Sign In</h2>
                <p class="auth-subtitle" id="authSubtitle">Access your personal dashboard</p>
                <div id="authError" class="auth-error"></div>
                <form id="authForm" onsubmit="handleAuth(event)">
                    <div class="form-group">
                        <label for="authEmail">Email</label>
                        <input type="email" id="authEmail" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Password</label>
                        <input type="password" id="authPassword" required placeholder="Your password" minlength="6">
                    </div>
                    <button type="submit" class="btn-primary" id="authSubmitBtn">Sign In</button>
                </form>
                <div class="auth-toggle">
                    <span id="authToggleText">Don't have an account?</span>
                    <a onclick="toggleAuthMode()"> <span id="authToggleLink">Sign Up</span></a>
                </div>
            </div>
        </div>
    </section>

    <!-- ============================================ -->
    <!-- DASHBOARD (shown when logged in)            -->
    <!-- ============================================ -->
    <div id="dashboardContainer" style="display: none;">

        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-bar-left">
                <span class="user-bar-email"><i class="fa-solid fa-user"></i> <span id="userEmail"></span></span>
                <button id="coachToggleBtn" class="coach-toggle-btn" style="display:none;" onclick="toggleCoachView()">
                    <i class="fa-solid fa-clipboard-user"></i> <span id="coachToggleLabel">Coach View</span>
                </button>
            </div>
            <div class="user-bar-right">
                <div style="position:relative;">
                    <button class="notification-bell" id="notificationBell" onclick="toggleNotificationPanel()">
                        <i class="fa-solid fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
                    </button>
                    <div class="notification-panel" id="notificationPanel">
                        <div class="notification-panel-header">
                            <span>Notifications</span>
                            <a onclick="markAllNotificationsRead()">Mark All Read</a>
                        </div>
                        <div id="notificationList">
                            <div class="notification-empty">No notifications</div>
                        </div>
                    </div>
                </div>
                <button onclick="openAccountModal()" title="Account Settings"><i class="fa-solid fa-gear"></i> Account</button>
                <button onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</button>
            </div>
        </div>

        <!-- Subscription Status Bar (populated by JS) -->
        <div id="subStatusBar" style="display: none;"></div>

        <!-- Coaching Call Banner (shown after purchase) -->
        <div id="coachingCallBanner" style="display: none;" class="coaching-call-banner">
            <p><i class="fa-solid fa-check-circle" style="color: #27AE60;"></i> <strong>Coaching Call Purchased!</strong> Book your 30-minute session now.</p>
            <a href="https://api.leadconnectorhq.com/widget/booking/COACHING_CALENDAR_ID" target="_blank">Schedule Your Call &rarr;</a>
        </div>

        <!-- Dashboard Hero Image -->
        <section class="dash-hero">
            <img src="images/hero-blueprint-how-to-use.webp" alt="Athlete Dashboard" class="dash-hero-bg">
            <div class="dash-hero-container">
                <div class="dash-hero-content">
                    <div class="dash-hero-subtitle">Athlete Dashboard</div>
                    <h1>Your Blueprint Command Center</h1>
                </div>
            </div>
        </section>

        <!-- Section 1: Phase Status Banner -->
        <div class="phase-banner" id="phaseBanner">
            <div class="phase-banner-label" id="phaseBannerLabel">PHASE 1: BASELINE</div>
            <div class="phase-banner-dates" id="phaseBannerDates">January 1 to March 31</div>
            <div class="phase-banner-countdown" id="phaseBannerCountdown">90 days remaining</div>
            <div class="phase-progress-bar">
                <div class="phase-progress-fill" id="phaseProgressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Blueprint Sub-Nav -->
        <div class="blueprint-subnav">
            <div class="blueprint-subnav-container">
                <a href="blueprint-dashboard.html" class="active">My Dashboard</a>
                <a href="blueprint-phase-1-maintain.html">Phase 1: Baseline</a>
                <a href="blueprint-phase-2-cut.html">Phase 2: Cut</a>
                <a href="blueprint-phase-3-maintain.html">Phase 3: Maintain</a>
                <a href="blueprint-phase-4-build.html">Phase 4: Build</a>
                <a href="blueprint-supplements.html">Supplements</a>
                <a href="blueprint-decade.html">Decade Roadmap</a>
            </div>
        </div>

        <!-- Phase Transition Card (shown ~14 days before phase end) -->
        <section class="section" id="transitionSection" style="display: none;">
            <div class="section-container">
                <div class="transition-card">
                    <div class="transition-card-badge"><i class="fa-solid fa-arrow-right-arrow-left"></i> Phase Transition Coming</div>
                    <h3 id="transitionTitle">Preparing for Phase 2: Cut</h3>
                    <p id="transitionDesc">Your current phase is wrapping up. Here's what changes when you move to the next phase.</p>
                    <div class="transition-changes" id="transitionChanges"></div>
                    <div class="transition-cta">
                        <p><strong>This is the #1 moment athletes fall off track.</strong> A 30-minute coaching call can set your next 3 months up for success.</p>
                        <a href="PLACEHOLDER_COACHING_BOOKING_URL" class="btn-primary" id="transitionCtaBtn">Book a Coaching Call</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: My Macros -->
        <section class="section">
            <div class="section-container">
                <div class="dash-card">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-fire"></i> My Macros</h3>
                        <button class="btn-secondary btn-small" onclick="openCalcModal()">Recalculate</button>
                    </div>
                    <div id="macrosContent">
                        <!-- Coach Macro Change Banner (shown to athlete when coach updates macros) -->
                        <div class="macro-change-banner" id="macroChangeBanner">
                            <div class="macro-change-banner-header">
                                <i class="fa-solid fa-user-pen"></i>
                                <span>Coach Updated Your Macros</span>
                            </div>
                            <div class="macro-change-values" id="macroChangeValues"></div>
                            <div class="macro-change-note" id="macroChangeNote" style="display:none;"></div>
                            <button class="macro-change-dismiss" onclick="dismissMacroChange()">Got It</button>
                        </div>
                        <div id="macrosPopulated" style="display: none;">
                            <!-- Calories Hero -->
                            <div class="macro-calories-hero">
                                <div class="macro-calories-number" id="macroCals">--</div>
                                <div class="macro-calories-label">CALORIES / DAY</div>
                            </div>
                            <!-- Pie Chart + Legend Layout -->
                            <div class="macro-visual-row">
                                <div class="macro-chart-wrap">
                                    <canvas id="macroPieChart"></canvas>
                                </div>
                                <div class="macro-legend">
                                    <div class="macro-legend-item">
                                        <span class="macro-legend-dot" style="background: var(--yellow);"></span>
                                        <div class="macro-legend-detail">
                                            <div class="macro-legend-name">Protein</div>
                                            <div class="macro-legend-value"><span id="macroProtein">--</span>g</div>
                                            <div class="macro-legend-pct" id="macroProteinPct">--%</div>
                                        </div>
                                    </div>
                                    <div class="macro-legend-item">
                                        <span class="macro-legend-dot" style="background: #4CAF50;"></span>
                                        <div class="macro-legend-detail">
                                            <div class="macro-legend-name">Carbs</div>
                                            <div class="macro-legend-value"><span id="macroCarbs">--</span>g</div>
                                            <div class="macro-legend-pct" id="macroCarbsPct">--%</div>
                                        </div>
                                    </div>
                                    <div class="macro-legend-item">
                                        <span class="macro-legend-dot" style="background: #2196F3;"></span>
                                        <div class="macro-legend-detail">
                                            <div class="macro-legend-name">Fat</div>
                                            <div class="macro-legend-value"><span id="macroFat">--</span>g</div>
                                            <div class="macro-legend-pct" id="macroFatPct">--%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="macrosEmpty" class="empty-state">
                            <i class="fa-solid fa-calculator"></i>
                            <p>No macros saved for this phase yet.</p>
                            <button class="btn-primary btn-small" onclick="openCalcModal()">Calculate Your Macros</button>
                        </div>
                    </div>
                    <div id="macroActions" style="display: none; margin-top: 1.5rem; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                        <button class="btn-secondary btn-small" onclick="generatePhasePDF()" id="downloadPdfBtn" title="Download Phase Plan PDF"><i class="fa-solid fa-file-pdf" style="margin-right: 0.4rem;"></i> Download PDF</button>
                        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
                            <i class="fa-solid fa-floppy-disk"></i> Save My Macros
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <form class="dash-form" id="macroForm" onsubmit="saveMacros(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="macroCalInput">Calories</label>
                                    <input type="number" id="macroCalInput" required min="800" max="8000" placeholder="e.g. 2200">
                                </div>
                                <div class="form-group">
                                    <label for="macroProteinInput">Protein (g)</label>
                                    <input type="number" id="macroProteinInput" required min="30" max="500" placeholder="e.g. 180">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="macroCarbsInput">Carbs (g)</label>
                                    <input type="number" id="macroCarbsInput" required min="0" max="800" placeholder="e.g. 220">
                                </div>
                                <div class="form-group">
                                    <label for="macroFatInput">Fat (g)</label>
                                    <input type="number" id="macroFatInput" required min="10" max="300" placeholder="e.g. 65">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="macroWeightInput">Body Weight (lbs)</label>
                                    <input type="number" id="macroWeightInput" min="50" max="700" step="0.1" placeholder="e.g. 185">
                                </div>
                                <div class="form-group">
                                    <label for="macroActivityInput">Activity Level</label>
                                    <select id="macroActivityInput">
                                        <option value="">Select...</option>
                                        <option value="1.2">Sedentary</option>
                                        <option value="1.375">Lightly Active</option>
                                        <option value="1.55">Moderately Active</option>
                                        <option value="1.725">Very Active</option>
                                        <option value="1.9">Extremely Active</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary btn-small">Save Macros</button>
                            <div id="macroSaveSuccess" class="form-success">Macros saved!</div>
                            <div id="macroSaveError" class="form-error">Error saving macros. Please try again.</div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Weight Tracker -->
        <section class="section section-alt">
            <div class="section-container">
                <div class="dash-card" style="background: var(--black);">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-weight-scale"></i> Weight Tracker</h3>
                    </div>
                    <form class="dash-form" id="weightForm" onsubmit="saveWeight(event)" style="margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weightInput">Weight (lbs)</label>
                                <input type="number" id="weightInput" required min="50" max="700" step="0.1" placeholder="e.g. 185.4">
                            </div>
                            <div class="form-group">
                                <label for="weightDate">Date</label>
                                <input type="date" id="weightDate">
                            </div>
                            <div class="form-group">
                                <label for="weightNotes">Notes (optional)</label>
                                <input type="text" id="weightNotes" placeholder="e.g. Post-vacation">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary btn-small">Log Weight</button>
                        <div id="weightSaveSuccess" class="form-success">Weight logged!</div>
                        <div id="weightSaveError" class="form-error">Error logging weight.</div>
                    </form>
                    <div class="stats-row stats-row-3" id="weightSummary">
                        <div class="stat-card">
                            <div class="stat-card-label">Start Weight</div>
                            <div class="stat-card-value" id="weightStart">--</div>
                            <div class="stat-card-unit">lbs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-label">Current Weight</div>
                            <div class="stat-card-value" id="weightCurrent">--</div>
                            <div class="stat-card-unit">lbs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-label">Change</div>
                            <div class="stat-card-value" id="weightChange">--</div>
                            <div class="stat-card-unit">lbs</div>
                        </div>
                    </div>
                    <div class="weight-chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div class="weight-history">
                        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
                            <i class="fa-solid fa-chevron-down"></i> Weight History
                        </button>
                        <div class="collapsible-content">
                            <div class="weight-history-list" id="weightHistoryList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: Body Composition -->
        <section class="section">
            <div class="section-container">
                <div class="dash-card">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-person-rays"></i> Body Composition</h3>
                        <button class="btn-outline btn-small" onclick="openBodyCompModal()">Log Body Comp</button>
                    </div>
                    <div id="bodyCompContent">
                        <div id="bodyCompPopulated" style="display: none;">
                            <div class="body-comp-summary" id="bodyCompSummary"></div>
                            <div class="weight-chart-container" style="margin-top: 1rem;">
                                <canvas id="bodyCompChart"></canvas>
                            </div>
                        </div>
                        <div id="bodyCompEmpty" class="empty-state">
                            <i class="fa-solid fa-chart-line"></i>
                            <p>No body composition data logged yet.</p>
                            <button class="btn-primary btn-small" onclick="openBodyCompModal()">Log Your First Entry</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 5: Phase Transition Checklist -->
        <section class="section section-alt">
            <div class="section-container">
                <div class="dash-card" style="background: var(--black);">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-clipboard-check"></i> <span id="checklistTitle">Phase Transition Checklist</span></h3>
                    </div>
                    <p style="color: var(--light-gray); margin-bottom: 1.5rem;" id="checklistSubtitle">Complete these before moving to the next phase.</p>
                    <div class="checklist-interactive" id="checklistContainer"></div>
                </div>
            </div>
        </section>

        <!-- Section 6: Year-over-Year Summary -->
        <section class="section">
            <div class="section-container">
                <div class="dash-card">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-chart-column"></i> Year-over-Year Summary</h3>
                    </div>
                    <div id="yoyContent">
                        <div id="yoyPopulated" class="yoy-timeline" style="display: none;"></div>
                        <div id="yoyEmpty" class="empty-state">
                            <i class="fa-solid fa-calendar-days"></i>
                            <p>Your year-over-year data will appear here as you complete phases.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 7: Weekly Check-In -->
        <section class="section section-alt">
            <div class="section-container">
                <div class="dash-card" style="background: var(--black);">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-clipboard-question"></i> Weekly Check-In</h3>
                    </div>
                    <p style="color: var(--light-gray); margin-bottom: 1.5rem;">Take 2 minutes to reflect on your week. This data helps you (and your coach) spot trends and make better decisions.</p>
                    <form class="dash-form" id="checkinForm" onsubmit="saveCheckin(event)">
                        <div class="checkin-form-grid">
                            <div class="form-group">
                                <label for="checkinWeight">Average Weight This Week (lbs)</label>
                                <input type="number" id="checkinWeight" step="0.1" placeholder="e.g. 185.5">
                            </div>
                            <div class="form-group">
                                <label for="checkinEnergy">Energy Level</label>
                                <select id="checkinEnergy" style="background: var(--black); color: var(--white); border: 2px solid var(--medium-gray); padding: 0.75rem; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; width: 100%;">
                                    <option value="">Select...</option>
                                    <option value="5">High — felt great all week</option>
                                    <option value="4">Good — mostly energized</option>
                                    <option value="3">Average — some ups and downs</option>
                                    <option value="2">Low — struggled with energy</option>
                                    <option value="1">Very low — dragging all week</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Nutrition Adherence</label>
                                <div class="checkin-rating">
                                    <input type="radio" name="adherence" id="adh1" value="1"><label for="adh1">1</label>
                                    <input type="radio" name="adherence" id="adh2" value="2"><label for="adh2">2</label>
                                    <input type="radio" name="adherence" id="adh3" value="3"><label for="adh3">3</label>
                                    <input type="radio" name="adherence" id="adh4" value="4"><label for="adh4">4</label>
                                    <input type="radio" name="adherence" id="adh5" value="5"><label for="adh5">5</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Training Adherence</label>
                                <div class="checkin-rating">
                                    <input type="radio" name="training" id="train1" value="1"><label for="train1">1</label>
                                    <input type="radio" name="training" id="train2" value="2"><label for="train2">2</label>
                                    <input type="radio" name="training" id="train3" value="3"><label for="train3">3</label>
                                    <input type="radio" name="training" id="train4" value="4"><label for="train4">4</label>
                                    <input type="radio" name="training" id="train5" value="5"><label for="train5">5</label>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="checkinNotes">Notes / Wins / Struggles</label>
                                <textarea id="checkinNotes" rows="3" placeholder="How did this week go? Any wins to celebrate or obstacles to plan for?" style="background: var(--black); color: var(--white); border: 2px solid var(--medium-gray); padding: 0.75rem; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; width: 100%; resize: vertical;"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary btn-small">Submit Check-In</button>
                        <div id="checkinSaveSuccess" class="form-success">Check-in saved!</div>
                        <div id="checkinSaveError" class="form-error">Error saving check-in.</div>
                    </form>
                    <div class="checkin-history">
                        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
                            <i class="fa-solid fa-chevron-down"></i> Check-In History
                        </button>
                        <div class="collapsible-content">
                            <div id="checkinHistoryList"></div>
                            <div id="checkinEmpty" class="empty-state" style="padding: 2rem;">
                                <p>No check-ins yet. Submit your first one above!</p>
                            </div>
                            <div id="checkinCoachingUpsell" class="coaching-upsell" style="display: none;">
                                <h4><i class="fa-solid fa-chart-line" style="color: var(--yellow); margin-right: 0.5rem;"></i> See What a Coach Sees</h4>
                                <p>You've built a solid check-in history. Athletes who work with a coach see 2x better adherence and faster results. Let a coach analyze your data and build a plan around it.</p>
                                <a href="PLACEHOLDER_COACHING_BOOKING_URL" class="btn-primary">Book a Coaching Call — $99</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 8: Resources & Downloads -->
        <section class="section">
            <div class="section-container">
                <div class="dash-card">
                    <div class="dash-card-header">
                        <h3 class="dash-card-title"><i class="fa-solid fa-download"></i> Resources &amp; Downloads</h3>
                    </div>
                    <p style="color: var(--light-gray); margin-bottom: 2rem;">Printable tools to keep you on track. Download, print, and pin to your fridge.</p>
                    <div class="downloads-grid">
                        <a href="#" onclick="generatePhasePDF(); return false;" class="download-card" id="downloadPdfCard">
                            <i class="fa-solid fa-file-pdf"></i>
                            <h4>My Phase Plan</h4>
                            <p>Your custom macros, supplements, and phase checklist — generated from your dashboard data.</p>
                        </a>
                        <a href="Phase1-Baseline-Meal-Template.pdf" target="_blank" class="download-card" style="border-top: 3px solid var(--phase-baseline);">
                            <i class="fa-solid fa-utensils"></i>
                            <h4>Phase 1: Baseline Meals</h4>
                            <p>Sample meal structure for the Baseline phase.</p>
                        </a>
                        <a href="Phase2-Cut-Meal-Template.pdf" target="_blank" class="download-card" style="border-top: 3px solid var(--phase-cut);">
                            <i class="fa-solid fa-utensils"></i>
                            <h4>Phase 2: Cut Meals</h4>
                            <p>Sample meal structure for the Cut phase.</p>
                        </a>
                        <a href="Phase3-Maintain-Meal-Template.pdf" target="_blank" class="download-card" style="border-top: 3px solid var(--phase-maintain);">
                            <i class="fa-solid fa-utensils"></i>
                            <h4>Phase 3: Maintain Meals</h4>
                            <p>Sample meal structure for the Maintain phase.</p>
                        </a>
                        <a href="Phase4-Build-Meal-Template.pdf" target="_blank" class="download-card" style="border-top: 3px solid var(--phase-build);">
                            <i class="fa-solid fa-utensils"></i>
                            <h4>Phase 4: Build Meals</h4>
                            <p>Sample meal structure for the Build phase.</p>
                        </a>
                        <a href="Supplement-Quick-Reference.pdf" target="_blank" class="download-card">
                            <i class="fa-solid fa-capsules"></i>
                            <h4>Supplement Card</h4>
                            <p>Quick-reference card with dosages for every phase. Gym bag friendly.</p>
                        </a>
                        <a href="Competition-Prep-Modifier.pdf" target="_blank" class="download-card">
                            <i class="fa-solid fa-trophy"></i>
                            <h4>Competition Prep</h4>
                            <p>Modify your Blueprint around competition dates.</p>
                        </a>
                        <a href="Quarterly-Planning-Worksheet.pdf" target="_blank" class="download-card">
                            <i class="fa-solid fa-pen-to-square"></i>
                            <h4>Quarterly Planner</h4>
                            <p>Goal-setting worksheet for the start of each new phase.</p>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 9: Quick Links -->
        <section class="section section-alt">
            <div class="section-container">
                <div class="section-header">
                    <div class="section-subtitle">Quick Links</div>
                    <h2 class="section-title">Jump Back In</h2>
                </div>
                <div class="quick-links-grid features-grid" style="margin-top: 0;">
                    <a href="blueprint-phase-1-maintain.html" class="feature-card" id="quickLinkPhase">
                        <div class="feature-icon"><i class="fa-solid fa-book-open"></i></div>
                        <h3 id="quickLinkPhaseTitle">Go to Phase 1 Guide</h3>
                        <p>Read the full guide for your current phase.</p>
                    </a>
                    <a href="#" onclick="openCalcModal(); return false;" class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-calculator"></i></div>
                        <h3>Macro Calculator</h3>
                        <p>Calculate or recalculate your daily targets.</p>
                    </a>
                    <a href="blueprint-supplements.html" class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-capsules"></i></div>
                        <h3>Supplement Protocols</h3>
                        <p>Evidence-based supplement recommendations.</p>
                    </a>
                    <a href="blueprint-decade.html" class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-road"></i></div>
                        <h3>Decade Roadmap</h3>
                        <p>See your 10-year body composition trajectory.</p>
                    </a>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- COACH VIEW (hidden for athletes)             -->
        <!-- ============================================ -->
        <div class="coach-view-container" id="coachViewContainer">
            <!-- Coach Hero -->
            <div class="coach-hero">
                <h2><i class="fa-solid fa-clipboard-user" style="color:var(--yellow);margin-right:0.75rem;"></i>Coach Dashboard</h2>
                <p>Manage your athletes, review check-ins, and adjust nutrition plans.</p>
            </div>

            <!-- Coach Stats Bar -->
            <div class="coach-stats-bar" id="coachStatsBar">
                <div class="coach-stat">
                    <div class="coach-stat-value" id="coachStatTotal">0</div>
                    <div class="coach-stat-label">Total Athletes</div>
                </div>
                <div class="coach-stat">
                    <div class="coach-stat-value" id="coachStatCheckedIn">0</div>
                    <div class="coach-stat-label">Checked In This Week</div>
                </div>
                <div class="coach-stat attention">
                    <div class="coach-stat-value" id="coachStatAttention">0</div>
                    <div class="coach-stat-label">Need Attention</div>
                </div>
            </div>

            <!-- Coach Actions -->
            <div class="coach-actions-bar">
                <button class="btn-primary btn-small" onclick="openClaimModal()"><i class="fa-solid fa-user-plus"></i> Claim Athlete</button>
            </div>

            <!-- Client Card Grid -->
            <div class="client-card-grid" id="clientCardGrid">
                <div class="coach-loading" id="coachLoading">
                    <i class="fa-solid fa-spinner"></i>
                    <p>Loading athletes...</p>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- COACH DRILL-DOWN (single athlete view)       -->
        <!-- ============================================ -->
        <div class="coach-drilldown" id="coachDrilldown">
            <div class="coach-drilldown-header">
                <button class="coach-drilldown-back" onclick="backToCoachList()"><i class="fa-solid fa-arrow-left"></i> Back to Athletes</button>
                <span class="coach-drilldown-name" id="drilldownAthleteName">Athlete Name</span>
            </div>
            <div class="coach-drilldown-toolbar" id="drilldownToolbar">
                <button class="coach-action-btn" onclick="openCoachMacroModal()"><i class="fa-solid fa-fire"></i> Adjust Macros</button>
                <button class="coach-action-btn" onclick="coachLogWeight()"><i class="fa-solid fa-weight-scale"></i> Log Weight</button>
                <button class="coach-action-btn" onclick="openBodyCompModal()"><i class="fa-solid fa-person-rays"></i> Log Body Comp</button>
                <button class="coach-action-btn" onclick="openCoachNoteModal()"><i class="fa-solid fa-note-sticky"></i> Add Note</button>
                <button class="coach-action-btn danger" onclick="releaseAthlete()"><i class="fa-solid fa-user-minus"></i> Release</button>
            </div>

            <!-- Coach Notes Section (shown in drill-down) -->
            <section class="section">
                <div class="section-container">
                    <div class="dash-card">
                        <div class="dash-card-header">
                            <h3 class="dash-card-title"><i class="fa-solid fa-note-sticky"></i> Coach Notes</h3>
                        </div>
                        <div id="coachNotesContainer">
                            <div class="empty-state" id="coachNotesEmpty">
                                <i class="fa-solid fa-note-sticky"></i>
                                <p>No notes yet. Add a note using the toolbar above.</p>
                            </div>
                            <div id="coachNotesList"></div>
                        </div>
                    </div>

                    <!-- Macro Change Log -->
                    <div class="dash-card" style="margin-top:2rem;">
                        <div class="dash-card-header">
                            <h3 class="dash-card-title"><i class="fa-solid fa-clock-rotate-left"></i> Macro Change History</h3>
                        </div>
                        <div id="macroChangeLogContainer">
                            <div class="empty-state" id="macroLogEmpty">
                                <i class="fa-solid fa-clock-rotate-left"></i>
                                <p>No macro adjustments logged yet.</p>
                            </div>
                            <div id="macroChangeLogList"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </div><!-- end #dashboardContainer -->

    <!-- ============================================ -->
    <!-- COACH MODALS                                 -->
    <!-- ============================================ -->

    <!-- Claim Athlete Modal -->
    <div class="modal-overlay" id="claimModal">
        <div class="modal-container" style="max-width:550px;">
            <button class="modal-close" onclick="closeClaimModal()">&times;</button>
            <h3>Claim an Athlete</h3>
            <p style="color:var(--light-gray);margin-bottom:1.5rem;font-size:0.9rem;">Select an athlete to add to your roster.</p>
            <div class="claim-athlete-list" id="claimAthleteList">
                <div class="coach-loading"><i class="fa-solid fa-spinner"></i><p>Loading athletes...</p></div>
            </div>
        </div>
    </div>

    <!-- Coach Note Modal -->
    <div class="modal-overlay" id="coachNoteModal">
        <div class="modal-container" style="max-width:550px;">
            <button class="modal-close" onclick="closeCoachNoteModal()">&times;</button>
            <h3>Add Coach Note</h3>
            <form onsubmit="saveCoachNote(event)" class="dash-form">
                <div class="form-group">
                    <label>Category</label>
                    <select id="coachNoteCategory">
                        <option value="general">General</option>
                        <option value="checkin_review">Check-in Review</option>
                        <option value="macro_change">Macro Change</option>
                        <option value="body_comp">Body Comp</option>
                        <option value="phase_transition">Phase Transition</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="coachNoteText" rows="4" placeholder="Enter your private note..." required></textarea>
                </div>
                <button type="submit" class="btn-primary">Save Note</button>
            </form>
        </div>
    </div>

    <!-- Coach Macro Adjustment Modal -->
    <div class="modal-overlay" id="coachMacroModal">
        <div class="modal-container" style="max-width:600px;">
            <button class="modal-close" onclick="closeCoachMacroModal()">&times;</button>
            <h3>Adjust Athlete Macros</h3>
            <p style="color:var(--light-gray);margin-bottom:1rem;font-size:0.9rem;">Current values shown. Enter new targets below.</p>
            <div class="stats-row" style="margin-bottom:1.5rem;" id="coachMacroCurrentStats">
                <div class="stat-card"><div class="stat-card-label">Current Cal</div><div class="stat-card-value" id="cmCurrentCal">--</div></div>
                <div class="stat-card"><div class="stat-card-label">Protein</div><div class="stat-card-value" id="cmCurrentProtein">--</div></div>
                <div class="stat-card"><div class="stat-card-label">Carbs</div><div class="stat-card-value" id="cmCurrentCarbs">--</div></div>
                <div class="stat-card"><div class="stat-card-label">Fat</div><div class="stat-card-value" id="cmCurrentFat">--</div></div>
            </div>
            <form onsubmit="coachSaveMacros(event)" class="dash-form">
                <div class="form-row">
                    <div class="form-group"><label>Calories</label><input type="number" id="cmNewCal" required min="800" max="8000"></div>
                    <div class="form-group"><label>Protein (g)</label><input type="number" id="cmNewProtein" required min="0" max="500"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Carbs (g)</label><input type="number" id="cmNewCarbs" required min="0" max="1000"></div>
                    <div class="form-group"><label>Fat (g)</label><input type="number" id="cmNewFat" required min="0" max="500"></div>
                </div>
                <div class="form-group">
                    <label>Coach Note (optional)</label>
                    <textarea id="cmCoachNote" rows="2" placeholder="Reason for adjustment..."></textarea>
                </div>
                <button type="submit" class="btn-primary">Update Macros</button>
                <div class="form-success" id="cmSaveSuccess">Macros updated and athlete notified!</div>
                <div class="form-error" id="cmSaveError">Error saving macros. Please try again.</div>
            </form>
        </div>
    </div>

    <!-- Map Section -->
    <div class="map-section">
        <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3344.9875647886857!2d-96.89026308820058!3d33.15034697358084!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x864c3a240f77e3f7%3A0x9f460209df528d6e!2sBlack%20Iron%20Athletics!5e0!3m2!1sen!2sus!4v1737509000000!5m2!1sen!2sus"
            title="Black Iron Athletics location on Google Maps"
            allowfullscreen=""
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <a href="index.html">
                    <img src="images/logo.png" alt="Black Iron Athletics" class="footer-logo" loading="lazy">
                </a>
                <p style="color: var(--light-gray); margin-bottom: 1rem;">Forging everyday people into everyday athletes through strength, community, and purpose.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="schedule.html">Class Schedule</a></li>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="#" onclick="openSubscribeModal(); return false;">Subscribe</a></li>
                    <li><a href="#" onclick="openCancelModal(); return false;">Cancel Membership</a></li>
                    <li><a href="privacy-policy.html">Terms & Privacy Policy</a></li>
                    <li><a href="privacy-policy.html#sms-terms">SMS Terms</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact</h3>
                <p style="color: var(--light-gray); margin-bottom: 1rem;">
                    279 Main St #122<br>
                    Frisco, TX 75036
                </p>
                <p style="margin-bottom: 1.5rem;">
                    <a href="tel:(972)785-7036" style="color: var(--yellow); font-weight: 700;">(972) 785-7036</a>
                </p>
            </div>
            <div class="footer-section">
                <h3>Hours</h3>
                <p style="color: var(--light-gray); margin-bottom: 1rem;">
                    Check our class calendar for an up to date schedule.
                </p>
                <p style="color: var(--yellow); font-weight: 700;">
                    Open Gym: 24/7
                </p>
            </div>
        </div>
        <div class="footer-bottom">
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: center; gap: 1.5rem; font-size: 1.5rem;">
                <a href="https://www.instagram.com/blackiron_athletics/" target="_blank" style="color: var(--light-gray); transition: color 0.3s ease;" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
                <a href="https://www.youtube.com/channel/UCF1XjUXEs81OWY70chem6vA" target="_blank" style="color: var(--light-gray); transition: color 0.3s ease;" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
                <a href="https://www.facebook.com/BlackIronAthletics/" target="_blank" style="color: var(--light-gray); transition: color 0.3s ease;" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
            </div>
            <p>&copy; 2026 Black Iron Athletics. All rights reserved.</p>
        </div>
    </footer>

    <!-- Body Comp Modal -->
    <div class="modal-overlay" id="bodyCompModal">
        <div class="modal-container">
            <button class="modal-close" onclick="closeBodyCompModal()">&times;</button>
            <h3>Log Body Composition</h3>
            <form class="dash-form" id="bodyCompForm" onsubmit="saveBodyComp(event)">
                <div class="form-group">
                    <label for="bodyCompSource">Source</label>
                    <select id="bodyCompSource" onchange="toggleBodyCompFields()">
                        <option value="inbody">InBody Scan</option>
                        <option value="dexa">DEXA Scan</option>
                        <option value="manual">Manual Measurements</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bodyCompDate">Date</label>
                    <input type="date" id="bodyCompDate">
                </div>
                <!-- InBody/DEXA Fields -->
                <div id="scanFields">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bcBodyFat">Body Fat %</label>
                            <input type="number" id="bcBodyFat" step="0.1" min="1" max="60" placeholder="e.g. 18.5">
                        </div>
                        <div class="form-group">
                            <label for="bcSMM">Skeletal Muscle Mass (lbs)</label>
                            <input type="number" id="bcSMM" step="0.1" min="10" max="300" placeholder="e.g. 85.2">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bcLBM">Lean Body Mass (lbs)</label>
                            <input type="number" id="bcLBM" step="0.1" min="30" max="400" placeholder="e.g. 155">
                        </div>
                        <div class="form-group">
                            <label for="bcFatMass">Body Fat Mass (lbs)</label>
                            <input type="number" id="bcFatMass" step="0.1" min="0" max="300" placeholder="e.g. 30.5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bcTBW">Total Body Water (lbs)</label>
                            <input type="number" id="bcTBW" step="0.1" min="10" max="300" placeholder="e.g. 100">
                        </div>
                        <div class="form-group">
                            <label for="bcInBodyScore">InBody Score</label>
                            <input type="number" id="bcInBodyScore" min="0" max="100" placeholder="e.g. 78">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bcBMR">BMR (kcal)</label>
                        <input type="number" id="bcBMR" min="500" max="5000" placeholder="e.g. 1750">
                    </div>
                </div>
                <!-- Manual Fields -->
                <div id="manualFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bcWaist">Waist (in)</label>
                            <input type="number" id="bcWaist" step="0.1" min="15" max="70" placeholder="e.g. 33.5">
                        </div>
                        <div class="form-group">
                            <label for="bcHip">Hip (in)</label>
                            <input type="number" id="bcHip" step="0.1" min="20" max="80" placeholder="e.g. 38">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bcChest">Chest (in)</label>
                            <input type="number" id="bcChest" step="0.1" min="20" max="70" placeholder="e.g. 42">
                        </div>
                        <div class="form-group">
                            <label for="bcArm">Arm (in)</label>
                            <input type="number" id="bcArm" step="0.1" min="5" max="30" placeholder="e.g. 15.5">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bcThigh">Thigh (in)</label>
                        <input type="number" id="bcThigh" step="0.1" min="10" max="45" placeholder="e.g. 24">
                    </div>
                </div>
                <button type="submit" class="btn-primary btn-small" style="margin-top: 1rem;">Save Body Comp</button>
                <div id="bodyCompSaveSuccess" class="form-success">Body comp saved!</div>
                <div id="bodyCompSaveError" class="form-error">Error saving body comp.</div>
            </form>
        </div>
    </div>

    <!-- Macro Calculator Modal -->
    <div class="modal-overlay" id="calcModal">
        <div class="modal-container">
            <button class="modal-close" onclick="closeCalcModal()">&times;</button>
            <h3><i class="fa-solid fa-calculator"></i> Macro Calculator</h3>
            <form class="dash-form" id="calcModalForm" onsubmit="calculateMacrosModal(event)">
                <!-- Gender -->
                <div class="form-group">
                    <label>Gender</label>
                    <div class="calc-gender-options">
                        <div class="calc-gender-option">
                            <input type="radio" id="calcMale" name="calcGender" value="male" checked>
                            <label for="calcMale"><i class="fa-solid fa-mars"></i> Male</label>
                        </div>
                        <div class="calc-gender-option">
                            <input type="radio" id="calcFemale" name="calcGender" value="female">
                            <label for="calcFemale"><i class="fa-solid fa-venus"></i> Female</label>
                        </div>
                    </div>
                </div>
                <!-- Age -->
                <div class="form-group">
                    <label for="calcAge">Age</label>
                    <input type="number" id="calcAge" min="15" max="100" placeholder="e.g. 30" required>
                    <div class="form-error" id="calcAgeError">Please enter an age between 15 and 100.</div>
                </div>
                <!-- Height -->
                <div class="form-group">
                    <label>Height</label>
                    <div class="calc-height-inputs">
                        <div class="calc-height-field">
                            <input type="number" id="calcFeet" min="3" max="8" placeholder="Feet" required>
                            <span class="calc-height-unit">ft</span>
                        </div>
                        <div class="calc-height-field">
                            <input type="number" id="calcInches" min="0" max="11" placeholder="Inches" required>
                            <span class="calc-height-unit">in</span>
                        </div>
                    </div>
                    <div class="form-error" id="calcHeightError">Please enter a valid height.</div>
                </div>
                <!-- Weight -->
                <div class="form-group">
                    <label for="calcWeight">Weight (lbs)</label>
                    <input type="number" id="calcWeight" min="50" max="700" placeholder="e.g. 180" required>
                    <div class="form-error" id="calcWeightError">Please enter a weight between 50 and 700 lbs.</div>
                </div>
                <!-- Activity -->
                <div class="form-group">
                    <label for="calcActivity">Activity Level</label>
                    <select id="calcActivity" required>
                        <option value="" disabled selected>Select your activity level</option>
                        <option value="1.2">Sedentary (desk job, little exercise)</option>
                        <option value="1.375">Lightly Active (light exercise 1-3 days/week)</option>
                        <option value="1.55">Moderately Active (exercise 3-5 days/week)</option>
                        <option value="1.725">Very Active (hard exercise 6-7 days/week)</option>
                        <option value="1.9">Extremely Active (athlete / physical job + training)</option>
                    </select>
                </div>
                <!-- Goal -->
                <div class="form-group">
                    <label>Goal</label>
                    <div class="calc-goal-options">
                        <div class="calc-goal-option">
                            <input type="radio" id="calcLose" name="calcGoal" value="lose">
                            <label for="calcLose"><i class="fa-solid fa-fire"></i> Lose Fat</label>
                        </div>
                        <div class="calc-goal-option">
                            <input type="radio" id="calcMaintain" name="calcGoal" value="maintain" checked>
                            <label for="calcMaintain"><i class="fa-solid fa-scale-balanced"></i> Maintain</label>
                        </div>
                        <div class="calc-goal-option">
                            <input type="radio" id="calcBuild" name="calcGoal" value="build">
                            <label for="calcBuild"><i class="fa-solid fa-dumbbell"></i> Build Muscle</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary btn-small" style="width: 100%;"><i class="fa-solid fa-calculator" style="margin-right: 0.5rem;"></i> Calculate My Macros</button>
            </form>
            <!-- Results (hidden until calculated) -->
            <div id="calcResults" style="display: none;">
                <hr style="border: 1px solid var(--medium-gray); margin: 1.5rem 0;">
                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Your Results</h3>
                <div class="calc-results">
                    <div class="calc-result-card highlighted">
                        <div class="calc-result-label">Calories</div>
                        <div class="calc-result-value" id="calcResultCals">--</div>
                        <div class="calc-result-unit">per day</div>
                    </div>
                    <div class="calc-result-card" style="border-top: 3px solid var(--yellow);">
                        <div class="calc-result-label">Protein</div>
                        <div class="calc-result-value" id="calcResultProtein">--</div>
                        <div class="calc-result-unit">grams</div>
                    </div>
                    <div class="calc-result-card" style="border-top: 3px solid #4CAF50;">
                        <div class="calc-result-label">Carbs</div>
                        <div class="calc-result-value" id="calcResultCarbs">--</div>
                        <div class="calc-result-unit">grams</div>
                    </div>
                    <div class="calc-result-card" style="border-top: 3px solid #2196F3;">
                        <div class="calc-result-label">Fat</div>
                        <div class="calc-result-value" id="calcResultFat">--</div>
                        <div class="calc-result-unit">grams</div>
                    </div>
                </div>
                <button class="btn-primary btn-small" onclick="useCalculatedMacros()" style="width: 100%;"><i class="fa-solid fa-arrow-right" style="margin-right: 0.5rem;"></i> Use These Macros</button>
            </div>
        </div>
    </div>

    <!-- Lead Capture Modal -->
    <div class="modal-overlay" id="leadModal">
        <div class="modal-container" style="padding: 0;">
            <button class="modal-close" onclick="closeLeadModal()">&times;</button>
            <iframe
                data-src="https://api.leadconnectorhq.com/widget/form/vw0hMdDkTCL6K5N3i7vF"
                style="width:100%;height:100%;border:none;border-radius:4px"
                id="inline-vw0hMdDkTCL6K5N3i7vF"
                data-layout="{'id':'INLINE'}"
                data-trigger-type="alwaysShow"
                data-trigger-value=""
                data-activation-type="alwaysActivated"
                data-activation-value=""
                data-deactivation-type="neverDeactivate"
                data-deactivation-value=""
                data-form-name="Form 2"
                data-height="565"
                data-layout-iframe-id="inline-vw0hMdDkTCL6K5N3i7vF"
                data-form-id="vw0hMdDkTCL6K5N3i7vF"
                title="Form 2"
            ></iframe>
        </div>
    </div>

    <div class="modal-overlay" id="cancelModal">
        <div class="modal-container" style="padding: 0;">
            <button class="modal-close" onclick="closeCancelModal()">&times;</button>
            <iframe
                data-src="https://api.leadconnectorhq.com/widget/form/d4jtjY9fM2Hv9zVTzLwj"
                style="width:100%;height:100%;border:none;border-radius:4px"
                id="inline-d4jtjY9fM2Hv9zVTzLwj"
                data-layout="{'id':'INLINE'}"
                data-trigger-type="alwaysShow"
                data-trigger-value=""
                data-activation-type="alwaysActivated"
                data-activation-value=""
                data-deactivation-type="neverDeactivate"
                data-deactivation-value=""
                data-form-name="Membership Cancellation Form"
                data-height="787"
                data-layout-iframe-id="inline-d4jtjY9fM2Hv9zVTzLwj"
                data-form-id="d4jtjY9fM2Hv9zVTzLwj"
                title="Membership Cancellation Form"
            ></iframe>
        </div>
    </div>

    <div class="modal-overlay" id="subscribeModal">
        <div class="modal-container" style="padding: 0;">
            <button class="modal-close" onclick="closeSubscribeModal()">&times;</button>
            <iframe
                data-src="https://api.leadconnectorhq.com/widget/form/GnNJNaEX8InuIeGxWjaI"
                style="width:100%;height:100%;border:none;border-radius:4px"
                id="inline-GnNJNaEX8InuIeGxWjaI"
                data-layout="{'id':'INLINE'}"
                data-trigger-type="alwaysShow"
                data-trigger-value=""
                data-activation-type="alwaysActivated"
                data-activation-value=""
                data-deactivation-type="neverDeactivate"
                data-deactivation-value=""
                data-form-name="Subscribe"
                data-height="430"
                data-layout-iframe-id="inline-GnNJNaEX8InuIeGxWjaI"
                data-form-id="GnNJNaEX8InuIeGxWjaI"
                title="Subscribe"
            ></iframe>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal-container" style="max-width:550px;">
            <button class="modal-close" onclick="closeAccountModal()">&times;</button>
            <h3><i class="fa-solid fa-gear"></i> Account Settings</h3>
            <div class="account-modal-body">

                <!-- Profile Section -->
                <div class="account-section">
                    <h4>Profile</h4>
                    <div class="dash-form">
                        <div class="form-group">
                            <label>Email</label>
                            <div class="account-field-readonly" id="accountEmail"></div>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <div><span class="account-role-badge" id="accountRole"></span></div>
                        </div>
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" id="accountDisplayName" placeholder="Enter your display name">
                        </div>
                        <div class="account-btn-row">
                            <button class="btn-primary" onclick="saveDisplayName()" style="padding:0.7rem 1.5rem;font-size:0.8rem;">Save Name</button>
                        </div>
                        <div class="account-msg" id="displayNameMsg"></div>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="account-section">
                    <h4>Change Password</h4>
                    <div class="dash-form">
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="accountNewPassword" placeholder="Enter new password" style="width:100%;padding:0.85rem 1rem;background:var(--black);border:2px solid var(--medium-gray);color:var(--white);font-family:'Montserrat',sans-serif;font-size:0.95rem;font-weight:500;">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="accountConfirmPassword" placeholder="Confirm new password" style="width:100%;padding:0.85rem 1rem;background:var(--black);border:2px solid var(--medium-gray);color:var(--white);font-family:'Montserrat',sans-serif;font-size:0.95rem;font-weight:500;">
                        </div>
                        <div class="account-btn-row">
                            <button class="btn-primary" onclick="changePassword()" style="padding:0.7rem 1.5rem;font-size:0.8rem;">Update Password</button>
                        </div>
                        <div class="account-msg" id="passwordMsg"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
// ===== SUPABASE INIT =====
// TODO: Replace with your Supabase project URL and anon key
var SUPABASE_URL = 'https://hmwfpwcookrwgsbnutyc.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhtd2Zwd2Nvb2tyd2dzYm51dHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NTUwMTcsImV4cCI6MjA4NzEzMTAxN30.CpX9hIshZqf68B10vPZXt7dHbSXE_aVqfmKuiWN_Lpw';
var supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

// ===== PHASE ENGINE =====
function getPhaseInfo(date) {
    var d = date || new Date();
    var month = d.getMonth(); // 0-indexed
    var year = d.getFullYear();
    var phases = [
        { num: 1, name: 'Baseline', startMonth: 0, endMonth: 2, color: 'var(--phase-baseline)', colorHex: '#9b59b6', link: 'blueprint-phase-1-maintain.html' },
        { num: 2, name: 'Cut', startMonth: 3, endMonth: 5, color: 'var(--phase-cut)', colorHex: '#ff0003', link: 'blueprint-phase-2-cut.html' },
        { num: 3, name: 'Maintain', startMonth: 6, endMonth: 8, color: 'var(--phase-maintain)', colorHex: '#2E86C1', link: 'blueprint-phase-3-maintain.html' },
        { num: 4, name: 'Build', startMonth: 9, endMonth: 11, color: 'var(--phase-build)', colorHex: '#27AE60', link: 'blueprint-phase-4-build.html' }
    ];
    var phase = phases[Math.floor(month / 3)];
    var startDate = new Date(year, phase.startMonth, 1);
    var endDate = new Date(year, phase.endMonth + 1, 0); // last day of end month
    var totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    var elapsed = Math.ceil((d - startDate) / (1000 * 60 * 60 * 24)) + 1;
    var remaining = Math.max(0, totalDays - elapsed);
    var progress = Math.min(100, Math.round((elapsed / totalDays) * 100));
    var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    return {
        num: phase.num,
        name: phase.name,
        color: phase.color,
        colorHex: phase.colorHex,
        link: phase.link,
        year: year,
        startDate: startDate,
        endDate: endDate,
        startLabel: monthNames[phase.startMonth] + ' 1',
        endLabel: monthNames[phase.endMonth] + ' ' + endDate.getDate(),
        totalDays: totalDays,
        remaining: remaining,
        progress: progress,
        quarterKey: 'Q' + phase.num + '_' + year
    };
}

function getNextTransition(phaseNum) {
    var transitions = {
        1: {
            label: 'Phase 1: Baseline → Phase 2: Cut',
            items: [
                { key: '1to2_stable', text: 'Weight has been stable (±2-3 lbs) for 2-3 weeks' },
                { key: '1to2_tracking', text: 'Been consistently tracking for 4+ weeks' },
                { key: '1to2_recalc', text: 'Recalculated macros with goal set to "Lose Fat"' },
                { key: '1to2_ready', text: 'Mentally prepared for a 12-week caloric deficit' }
            ]
        },
        2: {
            label: 'Phase 2 → Phase 3 (Maintain)',
            items: [
                { key: '2to3_complete', text: 'Completed the full 12-week cut phase' },
                { key: '2to3_recalc', text: 'Recalculated macros with goal set to "Maintain"' },
                { key: '2to3_reverse', text: 'Understand that the reverse diet should be gradual' },
                { key: '2to3_photos', text: 'Taken end-of-cut progress photos' }
            ]
        },
        3: {
            label: 'Phase 3 → Phase 4 (Build)',
            items: [
                { key: '3to4_stable', text: 'Weight has been stable (±2-3 lbs) for 3-4 weeks' },
                { key: '3to4_energy', text: 'Energy and performance are back to baseline' },
                { key: '3to4_recalc', text: 'Recalculated macros with goal set to "Build Muscle"' },
                { key: '3to4_expect', text: 'Understand that body weight will increase during this phase' }
            ]
        },
        4: {
            label: 'Phase 4: Build → Phase 1: Baseline',
            items: [
                { key: '4to1_complete', text: 'Completed the full 12-week build phase' },
                { key: '4to1_recalc', text: 'Recalculated macros with goal set to "Maintain"' },
                { key: '4to1_expect', text: 'Understand that maintenance means less food than building' },
                { key: '4to1_photos', text: 'Taken year-over-year comparison photos' }
            ]
        }
    };
    return transitions[phaseNum];
}

// ===== AUTH FLOW =====
var isSignUp = false;

function toggleAuthMode() {
    isSignUp = !isSignUp;
    document.getElementById('authTitle').textContent = isSignUp ? 'Create Account' : 'Sign In';
    document.getElementById('authSubtitle').textContent = isSignUp ? 'Start tracking your Blueprint progress' : 'Access your personal dashboard';
    document.getElementById('authSubmitBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
    document.getElementById('authToggleText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
    document.getElementById('authToggleLink').textContent = isSignUp ? 'Sign In' : 'Sign Up';
    document.getElementById('authError').style.display = 'none';
}

async function handleAuth(e) {
    e.preventDefault();
    if (!supabase) { showAuthError('Dashboard not configured yet. Please check back soon.'); return; }
    var email = document.getElementById('authEmail').value;
    var password = document.getElementById('authPassword').value;
    document.getElementById('authSubmitBtn').textContent = isSignUp ? 'Creating...' : 'Signing in...';
    document.getElementById('authSubmitBtn').disabled = true;
    try {
        var result;
        if (isSignUp) {
            result = await supabase.auth.signUp({ email: email, password: password });
        } else {
            result = await supabase.auth.signInWithPassword({ email: email, password: password });
        }
        if (result.error) {
            showAuthError(result.error.message);
        } else if (isSignUp && result.data && !result.data.session) {
            showAuthError('Check your email to confirm your account, then sign in.');
        } else {
            // On successful auth, claim any subscriptions tied to this email
            if (result.data.user) {
                await claimSubscriptionByEmail(result.data.user.id, result.data.user.email);
            }
            // Check for redirect param (from content page gate)
            var params = new URLSearchParams(window.location.search);
            var redirect = params.get('redirect');
            if (redirect && redirect.startsWith('blueprint-')) {
                window.location.href = redirect;
                return;
            }
            showDashboard(result.data.user);
        }
    } catch (err) {
        showAuthError('Something went wrong. Please try again.');
    }
    document.getElementById('authSubmitBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
    document.getElementById('authSubmitBtn').disabled = false;
}

function showAuthError(msg) {
    var el = document.getElementById('authError');
    el.textContent = msg;
    el.style.display = 'block';
}

async function handleLogout() {
    if (supabase) { await supabase.auth.signOut(); }
    hideDashboard();
}

async function checkSession() {
    if (!supabase) return;
    var { data } = await supabase.auth.getSession();
    if (data && data.session) {
        // If redirected from a content page, send them back now that they're logged in
        var params = new URLSearchParams(window.location.search);
        var redirect = params.get('redirect');
        if (redirect && redirect.startsWith('blueprint-')) {
            window.location.href = redirect;
            return;
        }
        showDashboard(data.session.user);
    } else {
        // If redirected from Stripe with ?payment=success, prompt sign-in
        var params = new URLSearchParams(window.location.search);
        if (params.get('payment') === 'success') {
            showAuthError('Payment successful! Sign in or create an account with the same email to access your Blueprint.');
            document.getElementById('authError').style.color = '#27AE60';
        }
    }
}

// ===== STRIPE CUSTOMER PORTAL =====
// TODO: Replace with your Stripe Customer Portal link
var STRIPE_PORTAL_URL = 'STRIPE_CUSTOMER_PORTAL_URL';

// ===== SUBSCRIPTION MANAGEMENT =====
async function loadSubscription(userId, userEmail) {
    if (!supabase) return null;
    try {
        // Query subscription by user_id first, fallback to email
        var { data, error } = await supabase
            .from('subscriptions')
            .select('*')
            .eq('user_id', userId)
            .in('status', ['active', 'past_due'])
            .order('created_at', { ascending: false })
            .limit(1);

        // If table doesn't exist yet or other error, fail silently
        if (error) { renderSubStatus(null); return null; }

        if ((!data || data.length === 0) && userEmail) {
            // Fallback: check by email (pre-claim state)
            var result = await supabase
                .from('subscriptions')
                .select('*')
                .eq('customer_email', userEmail)
                .is('user_id', null)
                .in('status', ['active', 'past_due'])
                .order('created_at', { ascending: false })
                .limit(1);
            data = result.data;
        }

        var sub = data && data.length > 0 ? data[0] : null;
        renderSubStatus(sub);
        return sub;
    } catch (e) {
        // Table may not exist yet — fail silently
        renderSubStatus(null);
        return null;
    }
}

function renderSubStatus(sub) {
    var bar = document.getElementById('subStatusBar');
    if (!sub) {
        // No subscription found — keep bar hidden, don't show upsell
        bar.style.display = 'none';
        return;
    }
    var tierLabels = { blueprint: 'Blueprint Self-Guided', full_coaching: 'Full Coaching', coaching_call: 'Coaching Call' };
    var tierLabel = tierLabels[sub.tier] || sub.tier;
    var renewalText = '';
    if (sub.current_period_end) {
        var d = new Date(sub.current_period_end);
        renewalText = sub.cancel_at_period_end
            ? 'Access ends ' + d.toLocaleDateString()
            : 'Renews ' + d.toLocaleDateString();
    }
    var statusBadge = sub.status === 'past_due'
        ? ' <span style="color: #ff4444; font-weight: 700;">PAST DUE</span>'
        : '';
    bar.style.display = '';
    bar.className = 'sub-status-bar';
    bar.innerHTML = '<div class="sub-status-info">'
        + '<span class="sub-status-tier"><i class="fa-solid fa-crown"></i> ' + tierLabel + statusBadge + '</span>'
        + (renewalText ? '<span class="sub-status-detail">' + renewalText + '</span>' : '')
        + '</div>'
        + '<div class="sub-status-actions">'
        + '<a href="' + STRIPE_PORTAL_URL + '" target="_blank" class="sub-manage-link">Manage Billing</a>'
        + (sub.tier === 'blueprint' ? '<a href="blueprint.html#pricing" class="sub-upgrade-link">Upgrade to Coaching</a>' : '')
        + '</div>';
}

async function claimSubscriptionByEmail(userId, userEmail) {
    if (!supabase || !userEmail) return;
    try {
        // Claim any unclaimed subscriptions matching this email
        await supabase
            .from('subscriptions')
            .update({ user_id: userId })
            .eq('customer_email', userEmail)
            .is('user_id', null);
        // Also claim coaching calls
        await supabase
            .from('coaching_calls')
            .update({ user_id: userId })
            .eq('customer_email', userEmail)
            .is('user_id', null);
    } catch (e) {
        // Tables may not exist yet — fail silently
    }
}

async function loadCoachingCalls(userId, userEmail) {
    if (!supabase) return;
    try {
        var { data } = await supabase
            .from('coaching_calls')
            .select('*')
            .eq('user_id', userId)
            .order('purchased_at', { ascending: false });

        // Also check URL param for fresh purchase
        var params = new URLSearchParams(window.location.search);
        var showBanner = params.get('coaching') === 'success';

        if (showBanner || (data && data.some(function(c) { return c.status === 'purchased'; }))) {
            document.getElementById('coachingCallBanner').style.display = '';
        }
    } catch (e) {
        // Table may not exist yet — fail silently
    }
}

// ===== COACH STATE =====
var currentView = 'athlete'; // 'athlete' or 'coach'
var userRole = 'athlete';    // 'athlete', 'coach', or 'owner'
var userDisplayName = '';     // cached from profiles.display_name
var viewingAthleteId = null;  // set when coach drills into a client
var currentUser = null;       // the authenticated user object

function getTargetUserId() {
    if (currentView === 'coach' && viewingAthleteId) return viewingAthleteId;
    return currentUser ? currentUser.id : null;
}

// ===== DASHBOARD STATE =====
function showDashboard(user) {
    document.getElementById('authHero').style.display = 'none';
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    document.getElementById('userEmail').textContent = user.email;
    initDashboard(user);
}

function hideDashboard() {
    document.getElementById('authHero').style.display = '';
    document.getElementById('authSection').style.display = '';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('subStatusBar').style.display = 'none';
    document.getElementById('coachingCallBanner').style.display = 'none';
}

async function initDashboard(user) {
    currentUser = user;
    var phase = getPhaseInfo();
    renderPhaseBanner(phase);
    renderQuickLinks(phase);
    renderChecklist(phase);
    renderTransitionCard(phase);
    setWeightDateDefault();
    setBodyCompDateDefault();
    if (supabase && user) {
        // Detect coach/owner role
        try {
            var { data: profileData } = await supabase
                .from('profiles').select('role, display_name')
                .eq('id', user.id).single();
            if (profileData && profileData.role) {
                userRole = profileData.role;
            }
            if (profileData && profileData.display_name) {
                userDisplayName = profileData.display_name;
            }
        } catch (e) { console.log('Role detection error:', e); }

        // Show coach toggle if coach or owner
        if (userRole === 'coach' || userRole === 'owner') {
            document.getElementById('coachToggleBtn').style.display = '';
        }

        // Claim any unclaimed subscriptions first
        await claimSubscriptionByEmail(user.id, user.email);
        // Load subscription status
        loadSubscription(user.id, user.email);
        loadCoachingCalls(user.id, user.email);
        loadMacros(user.id, phase);
        loadWeightData(user.id, phase);
        loadBodyCompData(user.id);
        loadChecklistProgress(user.id, phase);
        loadYearOverYear(user.id);
        loadCheckins(user.id);
        // Load notifications for all users
        loadNotifications(user.id);
        // Check for coach macro changes
        checkMacroChanges(user.id, phase);
    }
}

// ===== PHASE BANNER =====
function renderPhaseBanner(phase) {
    var banner = document.getElementById('phaseBanner');
    banner.style.background = phase.colorHex;
    banner.style.color = phase.num === 4 ? '#000' : '#fff';
    document.getElementById('phaseBannerLabel').textContent = 'PHASE ' + phase.num + ': ' + phase.name.toUpperCase();
    document.getElementById('phaseBannerDates').textContent = phase.startLabel + ' to ' + phase.endLabel;
    document.getElementById('phaseBannerCountdown').textContent = phase.remaining + ' days remaining';
    document.getElementById('phaseProgressFill').style.width = phase.progress + '%';
}

// ===== QUICK LINKS =====
function renderQuickLinks(phase) {
    var link = document.getElementById('quickLinkPhase');
    link.href = phase.link;
    document.getElementById('quickLinkPhaseTitle').textContent = 'Go to Phase ' + phase.num + ' Guide';
}

// ===== MACROS =====
var macroPieChart = null;

function renderMacroPieChart(protein, carbs, fat) {
    var proteinCals = protein * 4;
    var carbsCals = carbs * 4;
    var fatCals = fat * 9;
    var totalCals = proteinCals + carbsCals + fatCals;

    var proteinPct = totalCals > 0 ? Math.round((proteinCals / totalCals) * 100) : 0;
    var carbsPct = totalCals > 0 ? Math.round((carbsCals / totalCals) * 100) : 0;
    var fatPct = totalCals > 0 ? 100 - proteinPct - carbsPct : 0;

    document.getElementById('macroProteinPct').textContent = proteinPct + '%';
    document.getElementById('macroCarbsPct').textContent = carbsPct + '%';
    document.getElementById('macroFatPct').textContent = fatPct + '%';

    var ctx = document.getElementById('macroPieChart');
    if (!ctx) return;
    if (macroPieChart) macroPieChart.destroy();

    macroPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Protein', 'Carbs', 'Fat'],
            datasets: [{
                data: [proteinCals, carbsCals, fatCals],
                backgroundColor: ['#FFD202', '#4CAF50', '#2196F3'],
                borderWidth: 0,
                hoverOffset: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '65%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a',
                    titleFont: { family: 'Montserrat', weight: '700' },
                    bodyFont: { family: 'Montserrat', weight: '500' },
                    padding: 12,
                    callbacks: {
                        label: function(ctx) {
                            var label = ctx.label;
                            var val = ctx.raw;
                            var pct = totalCals > 0 ? Math.round((val / totalCals) * 100) : 0;
                            return label + ': ' + val + ' cal (' + pct + '%)';
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                duration: 800
            }
        }
    });
}

async function loadMacros(userId, phase) {
    try {
        var { data, error } = await supabase.from('saved_macros').select('*')
            .eq('user_id', userId).eq('phase', phase.num).eq('year', phase.year).single();
        if (data && !error) {
            document.getElementById('macroCals').textContent = data.calories.toLocaleString();
            document.getElementById('macroProtein').textContent = data.protein;
            document.getElementById('macroCarbs').textContent = data.carbs;
            document.getElementById('macroFat').textContent = data.fat;
            document.getElementById('macrosPopulated').style.display = 'block';
            document.getElementById('macrosEmpty').style.display = 'none';
            document.getElementById('macroActions').style.display = 'flex';
            renderMacroPieChart(data.protein, data.carbs, data.fat);
            // Pre-fill form
            document.getElementById('macroCalInput').value = data.calories;
            document.getElementById('macroProteinInput').value = data.protein;
            document.getElementById('macroCarbsInput').value = data.carbs;
            document.getElementById('macroFatInput').value = data.fat;
            if (data.weight) document.getElementById('macroWeightInput').value = data.weight;
            if (data.activity_level) document.getElementById('macroActivityInput').value = data.activity_level;
        }
    } catch (e) { /* empty state shown by default */ }
}

async function saveMacros(e) {
    e.preventDefault();
    if (!supabase) return;
    var phase = getPhaseInfo();
    var targetId = getTargetUserId();
    if (!targetId) return;
    var payload = {
        user_id: targetId,
        phase: phase.num,
        year: phase.year,
        calories: parseInt(document.getElementById('macroCalInput').value),
        protein: parseInt(document.getElementById('macroProteinInput').value),
        carbs: parseInt(document.getElementById('macroCarbsInput').value),
        fat: parseInt(document.getElementById('macroFatInput').value),
        weight: parseFloat(document.getElementById('macroWeightInput').value) || null,
        activity_level: document.getElementById('macroActivityInput').value || null
    };
    try {
        var { error } = await supabase.from('saved_macros').upsert(payload, { onConflict: 'user_id,phase,year' });
        if (error) throw error;
        flashMessage('macroSaveSuccess');
        loadMacros(targetId, phase);
    } catch (err) {
        flashMessage('macroSaveError');
    }
}

// ===== WEIGHT TRACKER =====
var weightChart = null;

function todayLocalString() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function setWeightDateDefault() {
    document.getElementById('weightDate').value = todayLocalString();
}

async function saveWeight(e) {
    e.preventDefault();
    if (!supabase) return;
    var targetId = getTargetUserId();
    if (!targetId) return;
    var payload = {
        user_id: targetId,
        weight: parseFloat(document.getElementById('weightInput').value),
        logged_date: document.getElementById('weightDate').value,
        notes: document.getElementById('weightNotes').value || null
    };
    try {
        var { error } = await supabase.from('weight_log').insert(payload);
        if (error) throw error;
        flashMessage('weightSaveSuccess');
        document.getElementById('weightInput').value = '';
        document.getElementById('weightNotes').value = '';
        setWeightDateDefault();
        loadWeightData(targetId, getPhaseInfo());
    } catch (err) {
        flashMessage('weightSaveError');
    }
}

async function loadWeightData(userId, phase) {
    try {
        var { data, error } = await supabase.from('weight_log').select('*')
            .eq('user_id', userId).order('logged_date', { ascending: true });
        if (error || !data || data.length === 0) return;

        // Filter for current phase period
        var phaseStart = phase.startDate.toISOString().split('T')[0];
        var phaseEnd = phase.endDate.toISOString().split('T')[0];
        var phaseData = data.filter(function(d) { return d.logged_date >= phaseStart && d.logged_date <= phaseEnd; });

        if (phaseData.length > 0) {
            var startW = phaseData[0].weight;
            var currentW = phaseData[phaseData.length - 1].weight;
            var change = (currentW - startW).toFixed(1);
            document.getElementById('weightStart').textContent = startW.toFixed(1);
            document.getElementById('weightCurrent').textContent = currentW.toFixed(1);
            document.getElementById('weightChange').textContent = (change > 0 ? '+' : '') + change;
            var changeEl = document.getElementById('weightChange');
            if (change < 0) changeEl.style.color = 'var(--phase-cut)';
            else if (change > 0) changeEl.style.color = 'var(--phase-build)';
            else changeEl.style.color = 'var(--phase-maintain)';
        }

        renderWeightChart(data);
        renderWeightHistory(phaseData);
    } catch (e) { /* fail silently */ }
}

function renderWeightChart(data) {
    var ctx = document.getElementById('weightChart').getContext('2d');
    if (weightChart) weightChart.destroy();

    var labels = data.map(function(d) { return d.logged_date; });
    var weights = data.map(function(d) { return d.weight; });

    // Phase background bands plugin
    var phaseBandsPlugin = {
        id: 'phaseBands',
        beforeDraw: function(chart) {
            var xScale = chart.scales.x;
            var yScale = chart.scales.y;
            var ctx2 = chart.ctx;
            if (!xScale || !yScale) return;
            var year = new Date(data[0].logged_date).getFullYear();
            var endYear = new Date(data[data.length - 1].logged_date).getFullYear();
            for (var y = year; y <= endYear; y++) {
                var quarters = [
                    { start: y+'-01-01', end: y+'-03-31', color: 'rgba(46,134,193,0.08)' },
                    { start: y+'-04-01', end: y+'-06-30', color: 'rgba(255,0,3,0.08)' },
                    { start: y+'-07-01', end: y+'-09-30', color: 'rgba(46,134,193,0.08)' },
                    { start: y+'-10-01', end: y+'-12-31', color: 'rgba(39,174,96,0.08)' }
                ];
                quarters.forEach(function(q) {
                    var xStart = xScale.getPixelForValue(q.start);
                    var xEnd = xScale.getPixelForValue(q.end);
                    if (isNaN(xStart) || isNaN(xEnd)) return;
                    ctx2.fillStyle = q.color;
                    ctx2.fillRect(xStart, yScale.top, xEnd - xStart, yScale.bottom - yScale.top);
                });
            }
        }
    };

    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Weight (lbs)',
                data: weights,
                borderColor: '#FFD202',
                backgroundColor: 'rgba(255, 210, 2, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: '#FFD202',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a',
                    titleColor: '#fff',
                    bodyColor: '#ccc',
                    borderColor: '#333',
                    borderWidth: 1,
                    titleFont: { family: 'Montserrat', weight: '700' },
                    bodyFont: { family: 'Montserrat' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ccc', font: { family: 'Montserrat', size: 11 }, maxTicksLimit: 10 },
                    grid: { color: 'rgba(51,51,51,0.5)' }
                },
                y: {
                    ticks: { color: '#ccc', font: { family: 'Montserrat', size: 11 } },
                    grid: { color: 'rgba(51,51,51,0.5)' }
                }
            }
        },
        plugins: [phaseBandsPlugin]
    });
}

// ===== WEIGHT HISTORY =====
function renderWeightHistory(entries) {
    var container = document.getElementById('weightHistoryList');
    if (!container) return;
    if (!entries || entries.length === 0) {
        container.innerHTML = '<div class="weight-history-empty">No weight entries for this phase yet.</div>';
        return;
    }
    var sorted = entries.slice().sort(function(a, b) { return b.logged_date.localeCompare(a.logged_date); });
    var html = '';
    sorted.forEach(function(entry) {
        html += '<div class="weight-history-row" id="wh-row-' + entry.id + '">'
            + '<span class="weight-history-date">' + entry.logged_date + '</span>'
            + '<span class="weight-history-weight">' + entry.weight.toFixed(1) + ' lbs</span>'
            + '<span class="weight-history-notes">' + (entry.notes || '—') + '</span>'
            + '<span class="weight-history-actions">'
            + '<button onclick="editWeightEntry(\'' + entry.id + '\', \'' + entry.logged_date + '\', ' + entry.weight + ', \'' + (entry.notes || '').replace(/'/g, "\\'") + '\')" title="Edit"><i class="fa-solid fa-pen"></i></button>'
            + '<button class="delete-btn" onclick="deleteWeightEntry(\'' + entry.id + '\')" title="Delete"><i class="fa-solid fa-trash"></i></button>'
            + '</span>'
            + '</div>';
    });
    container.innerHTML = html;
}

function editWeightEntry(id, date, weight, notes) {
    var row = document.getElementById('wh-row-' + id);
    if (!row) return;
    row.innerHTML = '<input type="date" id="wh-date-' + id + '" value="' + date + '">'
        + '<input type="number" id="wh-weight-' + id + '" value="' + weight + '" step="0.1" min="50" max="700">'
        + '<input type="text" id="wh-notes-' + id + '" value="' + notes + '" placeholder="Notes">'
        + '<span class="weight-history-actions">'
        + '<button onclick="saveWeightEdit(\'' + id + '\')" title="Save" style="border-color:var(--phase-build);color:var(--phase-build)"><i class="fa-solid fa-check"></i></button>'
        + '<button onclick="cancelWeightEdit()" title="Cancel"><i class="fa-solid fa-xmark"></i></button>'
        + '</span>';
}

async function saveWeightEdit(id) {
    if (!supabase) return;
    var dateVal = document.getElementById('wh-date-' + id).value;
    var weightVal = parseFloat(document.getElementById('wh-weight-' + id).value);
    var notesVal = document.getElementById('wh-notes-' + id).value || null;
    if (!dateVal || isNaN(weightVal)) return;
    try {
        var { error } = await supabase.from('weight_log').update({
            logged_date: dateVal,
            weight: weightVal,
            notes: notesVal
        }).eq('id', id);
        if (error) throw error;
        var targetId = getTargetUserId();
        if (targetId) loadWeightData(targetId, getPhaseInfo());
    } catch (err) {
        alert('Error saving edit. Please try again.');
    }
}

function cancelWeightEdit() {
    var targetId = getTargetUserId();
    if (targetId) loadWeightData(targetId, getPhaseInfo());
}

async function deleteWeightEntry(id) {
    if (!confirm('Delete this weight entry? This cannot be undone.')) return;
    if (!supabase) return;
    try {
        var { error } = await supabase.from('weight_log').delete().eq('id', id);
        if (error) throw error;
        var targetId = getTargetUserId();
        if (targetId) loadWeightData(targetId, getPhaseInfo());
    } catch (err) {
        alert('Error deleting entry. Please try again.');
    }
}

// ===== BODY COMPOSITION =====
var bodyCompChart = null;

function setBodyCompDateDefault() {
    document.getElementById('bodyCompDate').value = todayLocalString();
}

function openBodyCompModal() {
    document.getElementById('bodyCompModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeBodyCompModal() {
    document.getElementById('bodyCompModal').classList.remove('active');
    document.body.style.overflow = '';
}

document.getElementById('bodyCompModal').addEventListener('click', function(e) {
    if (e.target === this) closeBodyCompModal();
});

function toggleBodyCompFields() {
    var source = document.getElementById('bodyCompSource').value;
    document.getElementById('scanFields').style.display = (source === 'manual') ? 'none' : 'block';
    document.getElementById('manualFields').style.display = (source === 'manual') ? 'block' : 'none';
}

async function saveBodyComp(e) {
    e.preventDefault();
    if (!supabase) return;
    var targetId = getTargetUserId();
    if (!targetId) return;
    var source = document.getElementById('bodyCompSource').value;
    var payload = {
        user_id: targetId,
        source: source,
        logged_date: document.getElementById('bodyCompDate').value,
        body_fat_pct: parseFloat(document.getElementById('bcBodyFat').value) || null,
        skeletal_muscle_mass: parseFloat(document.getElementById('bcSMM').value) || null,
        lean_body_mass: parseFloat(document.getElementById('bcLBM').value) || null,
        body_fat_mass: parseFloat(document.getElementById('bcFatMass').value) || null,
        total_body_water: parseFloat(document.getElementById('bcTBW').value) || null,
        inbody_score: parseInt(document.getElementById('bcInBodyScore').value) || null,
        bmr: parseInt(document.getElementById('bcBMR').value) || null,
        waist: parseFloat(document.getElementById('bcWaist').value) || null,
        hip: parseFloat(document.getElementById('bcHip').value) || null,
        chest: parseFloat(document.getElementById('bcChest').value) || null,
        arm: parseFloat(document.getElementById('bcArm').value) || null,
        thigh: parseFloat(document.getElementById('bcThigh').value) || null
    };
    try {
        var { error } = await supabase.from('body_composition').insert(payload);
        if (error) throw error;
        flashMessage('bodyCompSaveSuccess');
        closeBodyCompModal();
        loadBodyCompData(targetId);
    } catch (err) {
        flashMessage('bodyCompSaveError');
    }
}

async function loadBodyCompData(userId) {
    try {
        var { data, error } = await supabase.from('body_composition').select('*')
            .eq('user_id', userId).order('logged_date', { ascending: true });
        if (error || !data || data.length === 0) return;

        // Show latest entry summary
        var latest = data[data.length - 1];
        var summaryHtml = '';
        if (latest.body_fat_pct) summaryHtml += '<div class="body-comp-item"><div class="label">Body Fat</div><div class="value">' + latest.body_fat_pct + '%</div></div>';
        if (latest.skeletal_muscle_mass) summaryHtml += '<div class="body-comp-item"><div class="label">Skeletal Muscle</div><div class="value">' + latest.skeletal_muscle_mass + ' lbs</div></div>';
        if (latest.lean_body_mass) summaryHtml += '<div class="body-comp-item"><div class="label">Lean Mass</div><div class="value">' + latest.lean_body_mass + ' lbs</div></div>';
        if (latest.body_fat_mass) summaryHtml += '<div class="body-comp-item"><div class="label">Fat Mass</div><div class="value">' + latest.body_fat_mass + ' lbs</div></div>';
        if (latest.inbody_score) summaryHtml += '<div class="body-comp-item"><div class="label">InBody Score</div><div class="value">' + latest.inbody_score + '</div></div>';
        if (latest.bmr) summaryHtml += '<div class="body-comp-item"><div class="label">BMR</div><div class="value">' + latest.bmr + '</div></div>';
        if (latest.waist) summaryHtml += '<div class="body-comp-item"><div class="label">Waist</div><div class="value">' + latest.waist + ' in</div></div>';
        if (latest.hip) summaryHtml += '<div class="body-comp-item"><div class="label">Hip</div><div class="value">' + latest.hip + ' in</div></div>';

        if (summaryHtml) {
            document.getElementById('bodyCompSummary').innerHTML = summaryHtml;
            document.getElementById('bodyCompPopulated').style.display = 'block';
            document.getElementById('bodyCompEmpty').style.display = 'none';
        }

        // Render chart if we have body fat and/or SMM data across time
        var chartData = data.filter(function(d) { return d.body_fat_pct || d.skeletal_muscle_mass; });
        if (chartData.length >= 2) renderBodyCompChart(chartData);
    } catch (e) { /* fail silently */ }
}

function renderBodyCompChart(data) {
    var ctx = document.getElementById('bodyCompChart').getContext('2d');
    if (bodyCompChart) bodyCompChart.destroy();

    var labels = data.map(function(d) { return d.logged_date; });
    var bfData = data.map(function(d) { return d.body_fat_pct; });
    var smmData = data.map(function(d) { return d.skeletal_muscle_mass; });

    var datasets = [];
    if (bfData.some(function(v) { return v !== null; })) {
        datasets.push({
            label: 'Body Fat %',
            data: bfData,
            borderColor: '#ff0003',
            backgroundColor: 'rgba(255,0,3,0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#ff0003',
            yAxisID: 'y',
            tension: 0.3
        });
    }
    if (smmData.some(function(v) { return v !== null; })) {
        datasets.push({
            label: 'Skeletal Muscle (lbs)',
            data: smmData,
            borderColor: '#27AE60',
            backgroundColor: 'rgba(39,174,96,0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#27AE60',
            yAxisID: 'y1',
            tension: 0.3
        });
    }

    bodyCompChart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#ccc', font: { family: 'Montserrat', weight: '600' } }
                },
                tooltip: {
                    backgroundColor: '#1a1a1a',
                    titleColor: '#fff',
                    bodyColor: '#ccc',
                    borderColor: '#333',
                    borderWidth: 1,
                    titleFont: { family: 'Montserrat', weight: '700' },
                    bodyFont: { family: 'Montserrat' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ccc', font: { family: 'Montserrat', size: 11 }, maxTicksLimit: 10 },
                    grid: { color: 'rgba(51,51,51,0.5)' }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Body Fat %', color: '#ff0003', font: { family: 'Montserrat', weight: '700' } },
                    ticks: { color: '#ff0003', font: { family: 'Montserrat', size: 11 } },
                    grid: { color: 'rgba(51,51,51,0.5)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Muscle Mass (lbs)', color: '#27AE60', font: { family: 'Montserrat', weight: '700' } },
                    ticks: { color: '#27AE60', font: { family: 'Montserrat', size: 11 } },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

// ===== CHECKLIST =====
function renderChecklist(phase) {
    var transition = getNextTransition(phase.num);
    document.getElementById('checklistTitle').textContent = transition.label;
    var container = document.getElementById('checklistContainer');
    var html = '';
    transition.items.forEach(function(item) {
        html += '<div class="checklist-item" data-key="' + item.key + '">' +
            '<div class="checklist-checkbox" onclick="toggleChecklistItem(this, \'' + item.key + '\')"></div>' +
            '<span class="checklist-text">' + item.text + '</span>' +
            '</div>';
    });
    container.innerHTML = html;
}

async function toggleChecklistItem(el, key) {
    var isChecked = el.classList.toggle('checked');
    el.closest('.checklist-item').classList.toggle('checked', isChecked);
    if (!supabase) return;
    var targetId = getTargetUserId();
    if (!targetId) return;
    var phase = getPhaseInfo();
    try {
        if (isChecked) {
            await supabase.from('checklist_progress').upsert({
                user_id: targetId,
                item_key: key,
                phase: phase.num,
                year: phase.year,
                completed: true
            }, { onConflict: 'user_id,item_key,phase,year' });
        } else {
            await supabase.from('checklist_progress').delete()
                .eq('user_id', targetId).eq('item_key', key).eq('phase', phase.num).eq('year', phase.year);
        }
    } catch (e) { /* fail silently */ }
}

async function loadChecklistProgress(userId, phase) {
    try {
        var { data, error } = await supabase.from('checklist_progress').select('item_key')
            .eq('user_id', userId).eq('phase', phase.num).eq('year', phase.year).eq('completed', true);
        if (error || !data) return;
        data.forEach(function(row) {
            var item = document.querySelector('.checklist-item[data-key="' + row.item_key + '"]');
            if (item) {
                item.classList.add('checked');
                item.querySelector('.checklist-checkbox').classList.add('checked');
            }
        });
    } catch (e) { /* fail silently */ }
}

// ===== YEAR-OVER-YEAR =====
async function loadYearOverYear(userId) {
    try {
        var phaseNames = { 1: 'Baseline', 2: 'Cut', 3: 'Maintain', 4: 'Build' };
        var phaseColors = { 1: 'var(--phase-baseline)', 2: 'var(--phase-cut)', 3: 'var(--phase-maintain)', 4: 'var(--phase-build)' };
        var currentYear = new Date().getFullYear();

        var { data, error } = await supabase.from('phase_history').select('*')
            .eq('user_id', userId).order('year', { ascending: false }).order('phase', { ascending: true });

        var hasPhaseData = !error && data && data.length > 0;
        var html = '';

        if (hasPhaseData) {
            var byYear = {};
            data.forEach(function(row) {
                if (!byYear[row.year]) byYear[row.year] = [];
                byYear[row.year].push(row);
            });

            var years = Object.keys(byYear).sort(function(a, b) { return b - a; });

            years.forEach(function(year) {
                var phases = byYear[year];
                var isCurrentYear = parseInt(year) === currentYear;
                var badge = '';
                if (phases.length >= 4) {
                    badge = ' <span class="yoy-badge">Year Complete</span>';
                } else if (isCurrentYear) {
                    badge = ' <span class="yoy-badge" style="background: var(--yellow); color: var(--black);">Year to Date</span>';
                }
                html += '<div class="yoy-year">';
                html += '<div class="yoy-year-label">' + year + badge + '</div>';
                html += '<div class="yoy-phases">';
                phases.forEach(function(p) {
                    var change = p.end_weight && p.start_weight ? (p.end_weight - p.start_weight).toFixed(1) : null;
                    var changeClass = change < 0 ? 'loss' : change > 0 ? 'gain' : 'neutral';
                    var changeText = change !== null ? ((change > 0 ? '+' : '') + change + ' lbs') : '--';
                    var inProgress = isCurrentYear && !p.end_weight ? ' (In Progress)' : '';
                    html += '<div class="yoy-phase-card">';
                    html += '<div class="yoy-phase-name" style="color: ' + phaseColors[p.phase] + ';">Phase ' + p.phase + ': ' + phaseNames[p.phase] + inProgress + '</div>';
                    if (p.start_date && p.end_date) html += '<div class="yoy-phase-dates">' + p.start_date + ' to ' + p.end_date + '</div>';
                    else if (p.start_date) html += '<div class="yoy-phase-dates">Started ' + p.start_date + '</div>';
                    if (p.start_weight) html += '<div class="yoy-phase-weight">' + p.start_weight + ' → ' + (p.end_weight || 'current') + ' lbs</div>';
                    html += '<div class="yoy-phase-change ' + changeClass + '">' + changeText + '</div>';
                    html += '</div>';
                });
                html += '</div></div>';
            });
        }

        // Build YTD summary for current year if no phase data exists for it
        var hasCurrentYearPhases = hasPhaseData && data.some(function(r) { return r.year === currentYear; });
        if (!hasCurrentYearPhases) {
            var phase = getPhaseInfo();
            var ytdHtml = '<div class="yoy-year">';
            ytdHtml += '<div class="yoy-year-label">' + currentYear + ' <span class="yoy-badge" style="background: var(--yellow); color: var(--black);">Year to Date</span></div>';
            ytdHtml += '<div class="yoy-ytd-summary">';

            var yearStart = currentYear + '-01-01';
            var { data: logs, error: logErr } = await supabase.from('weight_logs').select('weight, logged_at')
                .eq('user_id', userId).gte('logged_at', yearStart).order('logged_at', { ascending: true });

            if (!logErr && logs && logs.length > 0) {
                var firstLog = logs[0];
                var lastLog = logs[logs.length - 1];
                var startWt = parseFloat(firstLog.weight);
                var currentWt = parseFloat(lastLog.weight);
                var ytdChange = (currentWt - startWt).toFixed(1);
                var changeClass = ytdChange < 0 ? 'loss' : ytdChange > 0 ? 'gain' : 'neutral';
                var changeSign = ytdChange > 0 ? '+' : '';
                var firstDate = new Date(firstLog.logged_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                var lastDate = new Date(lastLog.logged_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                ytdHtml += '<div class="yoy-ytd-row">';
                ytdHtml += '<div class="yoy-ytd-stat"><div class="yoy-ytd-label">Starting Weight</div><div class="yoy-ytd-value">' + startWt.toFixed(1) + '</div><div class="yoy-ytd-date">' + firstDate + '</div></div>';
                ytdHtml += '<div class="yoy-ytd-stat"><div class="yoy-ytd-label">Current Weight</div><div class="yoy-ytd-value">' + currentWt.toFixed(1) + '</div><div class="yoy-ytd-date">' + lastDate + '</div></div>';
                ytdHtml += '<div class="yoy-ytd-stat"><div class="yoy-ytd-label">YTD Change</div><div class="yoy-ytd-value ' + changeClass + '">' + changeSign + ytdChange + ' lbs</div><div class="yoy-ytd-date">' + logs.length + ' weigh-in' + (logs.length !== 1 ? 's' : '') + '</div></div>';
                ytdHtml += '</div>';
            } else {
                ytdHtml += '<div class="yoy-ytd-row" style="grid-template-columns: 1fr;">';
                ytdHtml += '<div class="yoy-ytd-stat"><div class="yoy-ytd-label" style="margin-bottom: 0.5rem;">No weigh-ins yet this year</div><div class="yoy-ytd-value" style="font-size: 1rem; color: var(--light-gray);">Log your first weigh-in in the Weight Tracker above to start tracking your progress.</div></div>';
                ytdHtml += '</div>';
            }

            ytdHtml += '<div class="yoy-ytd-phase">Currently in <strong style="color: ' + phase.color + ';">Phase ' + phase.num + ': ' + phase.name + '</strong></div>';
            ytdHtml += '</div></div>';
            html = ytdHtml + html;
        }

        // Always show the section if we built any html
        if (html) {
            document.getElementById('yoyPopulated').innerHTML = html;
            document.getElementById('yoyPopulated').style.display = 'block';
            document.getElementById('yoyEmpty').style.display = 'none';
        }
    } catch (e) { /* fail silently */ }
}

// ===== UTILITIES =====
function toggleCollapsible(btn) {
    btn.classList.toggle('open');
    var content = btn.nextElementSibling;
    content.classList.toggle('open');
}

function flashMessage(id) {
    var el = document.getElementById(id);
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 3000);
}

// ===== PHASE TRANSITION CARD =====
function renderTransitionCard(phase) {
    if (phase.remaining > 14) return; // only show within 14 days of phase end
    var nextPhaseNum = phase.num === 4 ? 1 : phase.num + 1;
    var nextYear = phase.num === 4 ? phase.year + 1 : phase.year;
    var nextPhase = getPhaseInfo(new Date(nextYear, nextPhaseNum === 1 ? 0 : (nextPhaseNum - 1) * 3, 15));

    var supplementChanges = {
        1: { from: 'Foundation stack', to: 'STOP creatine, ADD Weight Mgmt Stack' },
        2: { from: 'Cut protocol', to: 'Foundation stack only, RESTART creatine 5g' },
        3: { from: 'Foundation stack', to: 'Creatine 10g, ADD Glutamine, STOP Weight Mgmt' },
        4: { from: 'Build protocol', to: 'Foundation stack only, creatine 5g' }
    };
    var macroShifts = {
        1: 'Caloric deficit — reduce below maintenance',
        2: 'Back to maintenance — reverse diet slowly',
        3: 'Caloric surplus — 300-500 cal above maintenance',
        4: 'Maintenance — establish your new baseline'
    };
    var mindsetShifts = {
        1: 'Discipline and consistency — embrace the grind',
        2: 'Recovery and patience — let your body stabilize',
        3: 'Fuel for growth — eat with purpose',
        4: 'Reset and observe — find your new normal'
    };

    var changes = supplementChanges[phase.num];
    document.getElementById('transitionTitle').textContent = 'Preparing for Phase ' + nextPhase.num + ': ' + nextPhase.name;
    document.getElementById('transitionDesc').textContent = phase.remaining + ' days left in Phase ' + phase.num + ': ' + phase.name + '. Here\'s what changes next.';

    var changesHtml = '';
    changesHtml += '<div class="transition-change-item"><div class="transition-change-label">Macros Direction</div><div class="transition-change-value">' + macroShifts[phase.num] + '</div></div>';
    changesHtml += '<div class="transition-change-item"><div class="transition-change-label">Supplement Changes</div><div class="transition-change-value">' + changes.to + '</div></div>';
    changesHtml += '<div class="transition-change-item"><div class="transition-change-label">Mindset Shift</div><div class="transition-change-value">' + mindsetShifts[phase.num] + '</div></div>';
    document.getElementById('transitionChanges').innerHTML = changesHtml;
    document.getElementById('transitionSection').style.display = '';
}

// ===== WEEKLY CHECK-IN =====
async function saveCheckin(e) {
    e.preventDefault();
    if (!supabase) return;
    var targetId = getTargetUserId();
    if (!targetId) return;
    var phase = getPhaseInfo();
    var adherence = document.querySelector('input[name="adherence"]:checked');
    var training = document.querySelector('input[name="training"]:checked');

    var payload = {
        user_id: targetId,
        phase: phase.num,
        year: phase.year,
        avg_weight: parseFloat(document.getElementById('checkinWeight').value) || null,
        energy_level: parseInt(document.getElementById('checkinEnergy').value) || null,
        nutrition_adherence: adherence ? parseInt(adherence.value) : null,
        training_adherence: training ? parseInt(training.value) : null,
        notes: document.getElementById('checkinNotes').value.trim() || null,
        week_of: todayLocalString()
    };

    try {
        var { error } = await supabase.from('weekly_checkins').insert(payload);
        if (error) throw error;
        flashMessage('checkinSaveSuccess');
        document.getElementById('checkinForm').reset();
        loadCheckins(targetId);
    } catch (err) {
        flashMessage('checkinSaveError');
    }
}

async function loadCheckins(userId) {
    try {
        var { data, error } = await supabase.from('weekly_checkins').select('*')
            .eq('user_id', userId).order('week_of', { ascending: false }).limit(12);
        if (error || !data) return;

        var list = document.getElementById('checkinHistoryList');
        var empty = document.getElementById('checkinEmpty');
        var upsell = document.getElementById('checkinCoachingUpsell');

        if (data.length === 0) {
            list.innerHTML = '';
            empty.style.display = '';
            return;
        }

        empty.style.display = 'none';

        var phaseNames = { 1: 'Baseline', 2: 'Cut', 3: 'Maintain', 4: 'Build' };
        var phaseColors = { 1: 'var(--phase-baseline)', 2: 'var(--phase-cut)', 3: 'var(--phase-maintain)', 4: 'var(--phase-build)' };
        var energyLabels = { 5: 'High', 4: 'Good', 3: 'Average', 2: 'Low', 1: 'Very Low' };

        var html = '';
        data.forEach(function(entry) {
            var date = new Date(entry.week_of + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            var phaseColor = phaseColors[entry.phase] || 'var(--yellow)';
            html += '<div class="checkin-entry">';
            html += '<div class="checkin-entry-header">';
            html += '<span class="checkin-entry-date">' + date + '</span>';
            html += '<span class="checkin-entry-phase" style="color: ' + phaseColor + '; border-color: ' + phaseColor + ';">Phase ' + entry.phase + ': ' + (phaseNames[entry.phase] || '') + '</span>';
            html += '</div>';
            html += '<div class="checkin-entry-stats">';
            if (entry.avg_weight) html += '<span class="checkin-entry-stat">Weight: <strong>' + entry.avg_weight + ' lbs</strong></span>';
            if (entry.energy_level) html += '<span class="checkin-entry-stat">Energy: <strong>' + (energyLabels[entry.energy_level] || entry.energy_level) + '</strong></span>';
            if (entry.nutrition_adherence) html += '<span class="checkin-entry-stat">Nutrition: <strong>' + entry.nutrition_adherence + '/5</strong></span>';
            if (entry.training_adherence) html += '<span class="checkin-entry-stat">Training: <strong>' + entry.training_adherence + '/5</strong></span>';
            html += '</div>';
            if (entry.notes) html += '<div class="checkin-entry-notes">"' + entry.notes + '"</div>';
            html += '</div>';
        });

        list.innerHTML = html;

        // Show coaching upsell after 3+ check-ins
        if (data.length >= 3) {
            upsell.style.display = '';
        }
    } catch (e) { /* fail silently */ }
}

// ===== PDF GENERATOR (jsPDF — no html2canvas) =====
function generatePhasePDF() {
    if (typeof jspdf === 'undefined') return;
    var phase = getPhaseInfo();
    var cals = document.getElementById('macroCals').textContent;
    var protein = document.getElementById('macroProtein').textContent;
    var carbs = document.getElementById('macroCarbs').textContent;
    var fat = document.getElementById('macroFat').textContent;
    var proteinPct = document.getElementById('macroProteinPct').textContent;
    var carbsPct = document.getElementById('macroCarbsPct').textContent;
    var fatPct = document.getElementById('macroFatPct').textContent;
    var weightEl = document.getElementById('weightCurrent');
    var currentWeight = weightEl ? weightEl.textContent : '--';
    var hydrationOz = currentWeight !== '--' ? Math.round(parseFloat(currentWeight) / 2) : '???';

    var supplements = {
        1: [
            { name: 'Whey Protein', dose: '1-2 servings/day', note: 'Post-workout or between meals' },
            { name: 'Multivitamin', dose: 'As directed', note: 'With breakfast' },
            { name: 'BCAAs', dose: '1-2 servings/day', note: 'During or after training' },
            { name: 'Creatine', dose: '5g daily', note: 'Standard maintenance dose' }
        ],
        2: [
            { name: 'Whey Protein', dose: '1-2 servings/day', note: 'Critical for muscle preservation' },
            { name: 'Multivitamin', dose: 'As directed', note: 'Extra important during deficit' },
            { name: 'BCAAs', dose: '1-2 servings/day', note: 'Support recovery in deficit' },
            { name: 'Weight Mgmt Stack', dose: 'As directed', note: 'Metabolic support during cut' },
            { name: 'Creatine', dose: 'STOP', note: 'Water retention masks scale progress' }
        ],
        3: [
            { name: 'Whey Protein', dose: '1-2 servings/day', note: 'Post-workout or between meals' },
            { name: 'Multivitamin', dose: 'As directed', note: 'With breakfast' },
            { name: 'BCAAs', dose: '1-2 servings/day', note: 'During or after training' },
            { name: 'Creatine', dose: '5g daily', note: 'Restart - standard maintenance dose' }
        ],
        4: [
            { name: 'Whey Protein', dose: '1-2 servings/day', note: 'Support higher protein needs' },
            { name: 'Multivitamin', dose: 'As directed', note: 'With breakfast' },
            { name: 'BCAAs', dose: '1-2 servings/day', note: 'Recovery during high volume' },
            { name: 'Creatine', dose: '10g daily', note: 'Double dose for building phase' },
            { name: 'Glutamine', dose: '5g daily', note: 'Recovery and gut health' }
        ]
    };

    var tips = {
        1: ['Focus on consistency over perfection', 'Track everything, even on bad days', 'Don\'t restrict - just observe and measure', 'Weigh yourself 3x per week minimum'],
        2: ['Prioritize protein to preserve muscle', 'Stay hydrated - water helps manage hunger', 'Aim for 1-2 lbs/week max loss', 'Keep training intensity high'],
        3: ['Don\'t increase calories dramatically', 'Use this phase to lock in habits at your new weight', 'Reverse diet slowly if needed', 'Enjoy the phase - you earned it'],
        4: ['Surplus should be moderate: 300-500 cal above maintenance', 'Prioritize protein and carbs around training', 'Don\'t use bulking as an excuse for junk food', 'Some weight gain is expected - that\'s the point']
    };

    // Parse phase color to RGB
    var hex = phase.colorHex.replace('#', '');
    var pR = parseInt(hex.substring(0,2), 16);
    var pG = parseInt(hex.substring(2,4), 16);
    var pB = parseInt(hex.substring(4,6), 16);

    var doc = new jspdf.jsPDF({ unit: 'pt', format: 'letter' });
    var pw = 612; // page width in points
    var mx = 40; // margin x
    var cw = pw - mx * 2; // content width
    var y = 40; // current y position

    // Helper: draw filled rect
    function drawRect(x, yy, w, h, r, g, b) {
        doc.setFillColor(r, g, b);
        doc.rect(x, yy, w, h, 'F');
    }

    // Helper: section label
    function sectionLabel(text, yy) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text(text.toUpperCase(), mx, yy);
        return yy + 16;
    }

    // ===== HEADER =====
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.setTextColor(0, 0, 0);
    doc.text('PHASE ' + phase.num + ': ' + phase.name.toUpperCase(), mx, y + 22);
    doc.setFontSize(10);
    doc.setTextColor(120, 120, 120);
    doc.text(phase.startLabel + ' - ' + phase.endLabel + ', ' + phase.year, mx, y + 38);

    // Right side - brand
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text('BLACK IRON ATHLETICS', pw - mx, y + 22, { align: 'right' });
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('4-Phase Nutrition Blueprint', pw - mx, y + 35, { align: 'right' });

    y += 48;
    // Phase color line
    drawRect(mx, y, cw, 4, pR, pG, pB);
    y += 20;

    // ===== MACROS BOX =====
    y = sectionLabel('Your Daily Targets', y);
    drawRect(mx, y, cw, 70, 245, 245, 245);

    var colW = cw / 4;
    var macroData = [
        { val: cals, label: 'CALORIES', isPhaseColor: true },
        { val: protein + 'g', label: 'PROTEIN (' + proteinPct + ')' },
        { val: carbs + 'g', label: 'CARBS (' + carbsPct + ')' },
        { val: fat + 'g', label: 'FAT (' + fatPct + ')' }
    ];

    macroData.forEach(function(m, i) {
        var cx = mx + colW * i + colW / 2;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        if (m.isPhaseColor) { doc.setTextColor(pR, pG, pB); } else { doc.setTextColor(0, 0, 0); }
        doc.text(m.val, cx, y + 32, { align: 'center' });
        doc.setFontSize(7);
        doc.setTextColor(120, 120, 120);
        doc.text(m.label, cx, y + 48, { align: 'center' });
    });

    y += 84;

    // ===== HYDRATION =====
    drawRect(mx, y, cw, 42, 218, 235, 245);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text('Daily Hydration Target: ' + hydrationOz + ' oz', mx + 16, y + 18);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text('Half your bodyweight in ounces + 16-24 oz on training days', mx + 16, y + 32);
    y += 56;

    // ===== SUPPLEMENTS TABLE =====
    y = sectionLabel('Supplement Protocol', y);
    var suppData = supplements[phase.num];
    var tableColWidths = [cw * 0.28, cw * 0.25, cw * 0.47];

    // Header row
    drawRect(mx, y, cw, 20, 245, 245, 245);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(7);
    doc.setTextColor(80, 80, 80);
    doc.text('SUPPLEMENT', mx + 8, y + 13);
    doc.text('DOSAGE', mx + tableColWidths[0] + 8, y + 13);
    doc.text('NOTES', mx + tableColWidths[0] + tableColWidths[1] + 8, y + 13);
    y += 20;

    suppData.forEach(function(s) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        doc.text(s.name, mx + 8, y + 13);

        if (s.dose === 'STOP') {
            doc.setTextColor(255, 0, 3);
        } else {
            doc.setTextColor(0, 0, 0);
        }
        doc.text(s.dose, mx + tableColWidths[0] + 8, y + 13);

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(s.note, mx + tableColWidths[0] + tableColWidths[1] + 8, y + 13);

        y += 22;
        // Row divider
        doc.setDrawColor(220, 220, 220);
        doc.line(mx, y, mx + cw, y);
    });

    y += 16;

    // ===== PHASE TIPS =====
    y = sectionLabel('Phase ' + phase.num + ' Tips', y);
    var phaseTips = tips[phase.num];
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(60, 60, 60);

    phaseTips.forEach(function(tip) {
        drawRect(mx, y + 1, 5, 5, pR, pG, pB);
        doc.text(tip, mx + 14, y + 7);
        y += 16;
    });

    y += 16;

    // ===== FOOTER =====
    doc.setDrawColor(230, 230, 230);
    doc.line(mx, y, mx + cw, y);
    y += 16;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('The 4-Phase Nutrition Blueprint | Black Iron Athletics | blackironathletics.com', mx, y);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(pR, pG, pB);
    doc.text('Want this dialed in by a coach? blackironathletics.com/blueprint', pw - mx, y, { align: 'right' });

    // Save
    doc.save('BlackIron-Phase' + phase.num + '-' + phase.name + '-' + phase.year + '.pdf');
}

// ===== CALC MODAL =====
function openCalcModal() {
    // Auto-select goal based on current phase
    var phase = getPhaseInfo();
    if (phase.num === 2) {
        document.getElementById('calcLose').checked = true;
    } else if (phase.num === 4) {
        document.getElementById('calcBuild').checked = true;
    } else {
        document.getElementById('calcMaintain').checked = true;
    }
    document.getElementById('calcResults').style.display = 'none';
    document.getElementById('calcModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeCalcModal() {
    document.getElementById('calcModal').classList.remove('active');
    document.body.style.overflow = '';
}

document.getElementById('calcModal').addEventListener('click', function(e) {
    if (e.target === this) closeCalcModal();
});

function calculateMacrosModal(e) {
    e.preventDefault();

    var gender = document.querySelector('input[name="calcGender"]:checked').value;
    var age = parseInt(document.getElementById('calcAge').value);
    var feet = parseInt(document.getElementById('calcFeet').value);
    var inches = parseInt(document.getElementById('calcInches').value);
    var weight = parseFloat(document.getElementById('calcWeight').value);
    var activity = parseFloat(document.getElementById('calcActivity').value);
    var goal = document.querySelector('input[name="calcGoal"]:checked').value;

    // Validate
    var valid = true;
    document.querySelectorAll('#calcModalForm .form-error').forEach(function(el) { el.style.display = 'none'; });

    if (isNaN(age) || age < 15 || age > 100) {
        document.getElementById('calcAgeError').style.display = 'block';
        valid = false;
    }
    if (isNaN(feet) || feet < 3 || feet > 8 || isNaN(inches) || inches < 0 || inches > 11) {
        document.getElementById('calcHeightError').style.display = 'block';
        valid = false;
    }
    if (isNaN(weight) || weight < 50 || weight > 700) {
        document.getElementById('calcWeightError').style.display = 'block';
        valid = false;
    }
    if (!activity) { valid = false; }
    if (!valid) return;

    // Convert units
    var weightKg = weight * 0.453592;
    var heightCm = (feet * 12 + inches) * 2.54;

    // BMR (Mifflin-St Jeor)
    var bmr;
    if (gender === 'male') {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
    } else {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
    }

    // TDEE
    var tdee = bmr * activity;

    // Daily Target
    var dailyTarget;
    if (goal === 'lose') {
        dailyTarget = tdee * 0.80;
    } else if (goal === 'build') {
        dailyTarget = tdee * 1.10;
    } else {
        dailyTarget = tdee;
    }

    // Macros
    var proteinPerLb = (goal === 'maintain') ? 0.8 : 1.0;
    var fatPerLb = (goal === 'lose') ? 0.35 : 0.3;

    var proteinG = Math.round(weight * proteinPerLb);
    var fatG = Math.round(weight * fatPerLb);
    var proteinCals = proteinG * 4;
    var fatCals = fatG * 9;
    var carbsCals = Math.max(0, Math.round(dailyTarget) - proteinCals - fatCals);
    var carbsG = Math.round(carbsCals / 4);
    var totalCals = proteinCals + (carbsG * 4) + fatCals;

    // Show results
    document.getElementById('calcResultCals').textContent = totalCals;
    document.getElementById('calcResultProtein').textContent = proteinG;
    document.getElementById('calcResultCarbs').textContent = carbsG;
    document.getElementById('calcResultFat').textContent = fatG;
    document.getElementById('calcResults').style.display = 'block';

    // Store for transfer
    document.getElementById('calcResults').dataset.cals = totalCals;
    document.getElementById('calcResults').dataset.protein = proteinG;
    document.getElementById('calcResults').dataset.carbs = carbsG;
    document.getElementById('calcResults').dataset.fat = fatG;
    document.getElementById('calcResults').dataset.weight = weight;
    document.getElementById('calcResults').dataset.activity = activity;

    // Scroll results into view within modal
    document.getElementById('calcResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function useCalculatedMacros() {
    var results = document.getElementById('calcResults');
    document.getElementById('macroCalInput').value = results.dataset.cals;
    document.getElementById('macroProteinInput').value = results.dataset.protein;
    document.getElementById('macroCarbsInput').value = results.dataset.carbs;
    document.getElementById('macroFatInput').value = results.dataset.fat;
    document.getElementById('macroWeightInput').value = results.dataset.weight;
    document.getElementById('macroActivityInput').value = results.dataset.activity;

    // Auto-fill weight tracker
    document.getElementById('weightInput').value = results.dataset.weight;

    // Open the collapsible save form
    var toggle = document.querySelector('#macroForm').closest('.collapsible-content').previousElementSibling;
    if (!toggle.classList.contains('open')) {
        toggle.classList.add('open');
        toggle.nextElementSibling.classList.add('open');
    }

    closeCalcModal();
}

// ===== MODALS =====
function openLeadModal() {
    var modal = document.getElementById('leadModal');
    var iframe = modal.querySelector('iframe');
    if (iframe && !iframe.src && iframe.dataset.src) { iframe.src = iframe.dataset.src; }
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}
function closeLeadModal() {
    document.getElementById('leadModal').classList.remove('active');
    document.body.style.overflow = '';
}
document.getElementById('leadModal').addEventListener('click', function(e) {
    if (e.target === this) { closeLeadModal(); }
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeLeadModal(); closeCancelModal(); closeSubscribeModal(); closeBodyCompModal(); closeCalcModal(); }
});

function openCancelModal() {
    var modal = document.getElementById('cancelModal');
    var iframe = modal.querySelector('iframe');
    if (iframe && !iframe.src && iframe.dataset.src) { iframe.src = iframe.dataset.src; }
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}
function closeCancelModal() {
    document.getElementById('cancelModal').classList.remove('active');
    document.body.style.overflow = '';
}
document.getElementById('cancelModal').addEventListener('click', function(e) {
    if (e.target === this) { closeCancelModal(); }
});

function openSubscribeModal() {
    var modal = document.getElementById('subscribeModal');
    var iframe = modal.querySelector('iframe');
    if (iframe && !iframe.src && iframe.dataset.src) { iframe.src = iframe.dataset.src; }
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}
function closeSubscribeModal() {
    document.getElementById('subscribeModal').classList.remove('active');
    document.body.style.overflow = '';
}
document.getElementById('subscribeModal').addEventListener('click', function(e) {
    if (e.target === this) { closeSubscribeModal(); }
});

// ===== MOBILE NAV =====
function toggleMobileNav() {
    document.getElementById('mobileNav').classList.toggle('active');
    document.querySelector('.hamburger').classList.toggle('active');
    document.body.style.overflow = document.getElementById('mobileNav').classList.contains('active') ? 'hidden' : '';
}
function closeMobileNav() {
    document.getElementById('mobileNav').classList.remove('active');
    document.querySelector('.hamburger').classList.remove('active');
    document.body.style.overflow = '';
}

// ===== COACH VIEW TOGGLE =====
function toggleCoachView() {
    if (currentView === 'athlete') {
        showCoachView();
    } else {
        showAthleteView();
    }
}

function showCoachView() {
    currentView = 'coach';
    viewingAthleteId = null;
    document.getElementById('coachToggleLabel').textContent = 'My Dashboard';
    document.getElementById('coachToggleBtn').classList.add('active');

    // Hide athlete dashboard sections
    var dashSections = document.querySelectorAll('#dashboardContainer > section, #dashboardContainer > .blueprint-subnav, #dashboardContainer > .phase-banner, #dashboardContainer > .dash-hero, #dashboardContainer > #subStatusBar, #dashboardContainer > #coachingCallBanner');
    dashSections.forEach(function(el) { el.style.display = 'none'; });
    // Also hide transition section
    var transSection = document.getElementById('transitionSection');
    if (transSection) transSection.style.display = 'none';

    // Show coach view
    document.getElementById('coachViewContainer').classList.add('active');
    document.getElementById('coachDrilldown').classList.remove('active');
    loadCoachView();
}

function showAthleteView() {
    currentView = 'athlete';
    viewingAthleteId = null;
    document.getElementById('coachToggleLabel').textContent = 'Coach View';
    document.getElementById('coachToggleBtn').classList.remove('active');

    // Show athlete dashboard sections
    var dashSections = document.querySelectorAll('#dashboardContainer > section, #dashboardContainer > .blueprint-subnav, #dashboardContainer > .dash-hero, #dashboardContainer > #subStatusBar, #dashboardContainer > #coachingCallBanner');
    dashSections.forEach(function(el) { el.style.display = ''; });
    // Re-render phase banner visibility
    var phase = getPhaseInfo();
    document.getElementById('phaseBanner').style.display = '';
    renderTransitionCard(phase);

    // Hide coach view
    document.getElementById('coachViewContainer').classList.remove('active');
    document.getElementById('coachDrilldown').classList.remove('active');

    // Reload own data
    if (currentUser) {
        loadMacros(currentUser.id, phase);
        loadWeightData(currentUser.id, phase);
        loadBodyCompData(currentUser.id);
        loadChecklistProgress(currentUser.id, phase);
        loadCheckins(currentUser.id);
    }
}

// ===== COACH VIEW — CLIENT LIST =====
async function loadCoachView() {
    if (!supabase || !currentUser) return;
    var grid = document.getElementById('clientCardGrid');
    grid.innerHTML = '<div class="coach-loading"><i class="fa-solid fa-spinner"></i><p>Loading athletes...</p></div>';

    try {
        // Get assigned athletes
        var { data: assignments, error } = await supabase
            .from('coach_athletes')
            .select('athlete_id')
            .eq('coach_id', currentUser.id);

        if (error) throw error;

        if (!assignments || assignments.length === 0) {
            grid.innerHTML = '<div class="coach-empty-state" style="grid-column:1/-1;"><i class="fa-solid fa-users"></i><p>No athletes assigned yet.</p><button class="btn-primary btn-small" onclick="openClaimModal()"><i class="fa-solid fa-user-plus"></i> Claim Your First Athlete</button></div>';
            document.getElementById('coachStatTotal').textContent = '0';
            document.getElementById('coachStatCheckedIn').textContent = '0';
            document.getElementById('coachStatAttention').textContent = '0';
            return;
        }

        var athleteIds = assignments.map(function(a) { return a.athlete_id; });

        // Fetch profiles for all assigned athletes
        var { data: profiles } = await supabase
            .from('profiles')
            .select('id, email, display_name')
            .in('id', athleteIds);

        // Fetch latest weight for each athlete
        var { data: weights } = await supabase
            .from('weight_log')
            .select('user_id, weight, logged_date')
            .in('user_id', athleteIds)
            .order('logged_date', { ascending: false });

        // Fetch latest check-in for each
        var { data: checkins } = await supabase
            .from('weekly_checkins')
            .select('user_id, week_of, avg_weight, energy_level')
            .in('user_id', athleteIds)
            .order('week_of', { ascending: false });

        // Fetch current macros
        var phase = getPhaseInfo();
        var { data: macros } = await supabase
            .from('saved_macros')
            .select('user_id, calories, protein, carbs, fat')
            .in('user_id', athleteIds)
            .eq('phase', phase.num)
            .eq('year', phase.year);

        // Build lookup maps
        var latestWeight = {};
        var latestCheckin = {};
        var athleteMacros = {};

        if (weights) weights.forEach(function(w) {
            if (!latestWeight[w.user_id]) latestWeight[w.user_id] = w;
        });
        if (checkins) checkins.forEach(function(c) {
            if (!latestCheckin[c.user_id]) latestCheckin[c.user_id] = c;
        });
        if (macros) macros.forEach(function(m) {
            athleteMacros[m.user_id] = m;
        });

        var totalAthletes = athleteIds.length;
        var checkedInCount = 0;
        var needAttention = 0;
        var sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        var sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

        var html = '';
        (profiles || []).forEach(function(p) {
            var w = latestWeight[p.id];
            var c = latestCheckin[p.id];
            var m = athleteMacros[p.id];
            var recentCheckin = c && c.week_of >= sevenDaysAgoStr;
            if (recentCheckin) checkedInCount++;
            var stale = !c || c.week_of < sevenDaysAgoStr;
            if (stale) needAttention++;

            var name = p.display_name || p.email.split('@')[0];
            var weightVal = w ? w.weight.toFixed(1) : '--';
            var calVal = m ? m.calories : '--';
            var energyVal = c && c.energy_level ? c.energy_level + '/5' : '--';
            var checkinDate = c ? new Date(c.week_of + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Never';

            html += '<div class="client-card' + (stale ? ' needs-attention' : '') + '" onclick="drillIntoClient(\'' + p.id + '\', \'' + name.replace(/'/g, "\\'") + '\')">';
            html += '<div class="client-card-name">' + name + '</div>';
            html += '<div class="client-card-email">' + p.email + '</div>';
            html += '<div class="client-card-stats">';
            html += '<div class="client-card-stat"><div class="label">Weight</div><div class="value">' + weightVal + '</div></div>';
            html += '<div class="client-card-stat"><div class="label">Calories</div><div class="value">' + calVal + '</div></div>';
            html += '<div class="client-card-stat"><div class="label">Energy</div><div class="value">' + energyVal + '</div></div>';
            html += '</div>';
            html += '<div class="client-card-last-checkin' + (stale ? ' stale' : '') + '"><i class="fa-solid fa-clock"></i> Last check-in: ' + checkinDate + '</div>';
            html += '</div>';
        });

        grid.innerHTML = html;

        document.getElementById('coachStatTotal').textContent = totalAthletes;
        document.getElementById('coachStatCheckedIn').textContent = checkedInCount;
        document.getElementById('coachStatAttention').textContent = needAttention;
    } catch (e) {
        grid.innerHTML = '<div class="coach-empty-state" style="grid-column:1/-1;"><i class="fa-solid fa-exclamation-triangle"></i><p>Error loading athletes. Please try again.</p></div>';
    }
}

// ===== CLAIM & RELEASE ATHLETES =====
function openClaimModal() {
    document.getElementById('claimModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    loadClaimList();
}

function closeClaimModal() {
    document.getElementById('claimModal').classList.remove('active');
    document.body.style.overflow = '';
}

document.getElementById('claimModal').addEventListener('click', function(e) {
    if (e.target === this) closeClaimModal();
});

async function loadClaimList() {
    if (!supabase || !currentUser) return;
    var list = document.getElementById('claimAthleteList');
    list.innerHTML = '<div class="coach-loading"><i class="fa-solid fa-spinner"></i><p>Loading...</p></div>';

    try {
        // Get all profiles that are athletes
        var { data: athletes } = await supabase
            .from('profiles')
            .select('id, email, display_name, role')
            .eq('role', 'athlete')
            .order('email');

        // Get all current assignments
        var { data: assignments } = await supabase
            .from('coach_athletes')
            .select('coach_id, athlete_id');

        var assignmentMap = {};
        if (assignments) assignments.forEach(function(a) {
            assignmentMap[a.athlete_id] = a.coach_id;
        });

        if (!athletes || athletes.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:var(--light-gray);padding:2rem;">No athletes found.</p>';
            return;
        }

        var html = '';
        athletes.forEach(function(a) {
            var assignedTo = assignmentMap[a.athlete_id || a.id];
            var isYours = assignedTo === currentUser.id;
            var isAssigned = !!assignedTo;
            var name = a.display_name || a.email.split('@')[0];

            html += '<div class="claim-athlete-row">';
            html += '<div class="claim-athlete-info"><div class="claim-athlete-name">' + name + '</div><div class="claim-athlete-email">' + a.email + '</div></div>';
            if (isYours) {
                html += '<span class="claim-badge yours">Your Client</span>';
            } else if (isAssigned) {
                html += '<span class="claim-badge assigned">Assigned</span>';
            } else {
                html += '<button class="claim-btn" onclick="claimAthlete(\'' + a.id + '\')">Claim</button>';
            }
            html += '</div>';
        });

        list.innerHTML = html;
    } catch (e) {
        list.innerHTML = '<p style="text-align:center;color:#ff4444;padding:2rem;">Error loading athletes.</p>';
    }
}

async function claimAthlete(athleteId) {
    if (!supabase || !currentUser) return;
    try {
        var { error } = await supabase.from('coach_athletes').insert({
            coach_id: currentUser.id,
            athlete_id: athleteId,
            assigned_by: currentUser.id
        });
        if (error) throw error;
        loadClaimList();
        loadCoachView();
    } catch (e) {
        alert('Error claiming athlete. They may already be assigned.');
    }
}

async function releaseAthlete() {
    if (!viewingAthleteId) return;
    if (!confirm('Release this athlete from your roster? You can re-claim them later.')) return;
    if (!supabase || !currentUser) return;
    try {
        var { error } = await supabase.from('coach_athletes').delete()
            .eq('coach_id', currentUser.id)
            .eq('athlete_id', viewingAthleteId);
        if (error) throw error;
        backToCoachList();
        loadCoachView();
    } catch (e) {
        alert('Error releasing athlete. Please try again.');
    }
}

// ===== CLIENT DRILL-DOWN =====
function drillIntoClient(clientId, clientName) {
    viewingAthleteId = clientId;
    document.getElementById('drilldownAthleteName').textContent = clientName;

    // Hide client list, show drill-down
    document.getElementById('coachViewContainer').classList.remove('active');
    document.getElementById('coachDrilldown').classList.add('active');

    // Show the athlete's dashboard sections for the drill-down
    var dashSections = document.querySelectorAll('#dashboardContainer > section');
    dashSections.forEach(function(el) { el.style.display = ''; });
    document.getElementById('phaseBanner').style.display = '';

    // Load client data using existing functions
    var phase = getPhaseInfo();
    loadMacros(clientId, phase);
    loadWeightData(clientId, phase);
    loadBodyCompData(clientId);
    loadChecklistProgress(clientId, phase);
    loadCheckins(clientId);
    loadYearOverYear(clientId);
    // Load coach-only data
    loadCoachNotes(clientId);
    loadMacroChangeLog(clientId);
}

function backToCoachList() {
    viewingAthleteId = null;
    document.getElementById('coachDrilldown').classList.remove('active');

    // Hide athlete dashboard sections again
    var dashSections = document.querySelectorAll('#dashboardContainer > section, #dashboardContainer > .blueprint-subnav, #dashboardContainer > .phase-banner, #dashboardContainer > .dash-hero');
    dashSections.forEach(function(el) { el.style.display = 'none'; });

    // Show coach view
    document.getElementById('coachViewContainer').classList.add('active');
    loadCoachView();
}

function coachLogWeight() {
    // Scroll to weight section and open the form
    var weightSection = document.getElementById('weightInput');
    if (weightSection) {
        weightSection.closest('.section').scrollIntoView({ behavior: 'smooth' });
        // Open collapsible if closed
        var toggle = weightSection.closest('.dash-card').querySelector('.collapsible-toggle');
        var content = weightSection.closest('.dash-card').querySelector('.collapsible-content');
        if (toggle && content && !content.classList.contains('open')) {
            toggle.classList.add('open');
            content.classList.add('open');
        }
    }
}

// ===== COACH NOTES =====
function openCoachNoteModal() {
    document.getElementById('coachNoteModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    document.getElementById('coachNoteText').value = '';
    document.getElementById('coachNoteCategory').value = 'general';
}

function closeCoachNoteModal() {
    document.getElementById('coachNoteModal').classList.remove('active');
    document.body.style.overflow = '';
}

document.getElementById('coachNoteModal').addEventListener('click', function(e) {
    if (e.target === this) closeCoachNoteModal();
});

async function saveCoachNote(e) {
    e.preventDefault();
    if (!supabase || !currentUser || !viewingAthleteId) return;
    var note = document.getElementById('coachNoteText').value.trim();
    var category = document.getElementById('coachNoteCategory').value;
    if (!note) return;

    try {
        var { error } = await supabase.from('coach_notes').insert({
            coach_id: currentUser.id,
            athlete_id: viewingAthleteId,
            note: note,
            category: category
        });
        if (error) throw error;
        closeCoachNoteModal();
        loadCoachNotes(viewingAthleteId);
    } catch (e) {
        alert('Error saving note. Please try again.');
    }
}

async function loadCoachNotes(athleteId) {
    if (!supabase) return;
    var container = document.getElementById('coachNotesList');
    var empty = document.getElementById('coachNotesEmpty');

    try {
        var { data, error } = await supabase.from('coach_notes').select('*')
            .eq('athlete_id', athleteId)
            .order('created_at', { ascending: false })
            .limit(50);
        if (error) throw error;

        if (!data || data.length === 0) {
            container.innerHTML = '';
            empty.style.display = '';
            return;
        }

        empty.style.display = 'none';
        var categoryLabels = { general: 'General', checkin_review: 'Check-in Review', macro_change: 'Macro Change', body_comp: 'Body Comp', phase_transition: 'Phase Transition' };
        var html = '';
        data.forEach(function(n) {
            var date = new Date(n.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
            html += '<div class="coach-note-entry">';
            html += '<div class="coach-note-meta"><span class="coach-note-date">' + date + '</span><span class="coach-note-category">' + (categoryLabels[n.category] || n.category) + '</span></div>';
            html += '<div class="coach-note-text">' + n.note.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
            html += '</div>';
        });
        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = '<p style="color:#ff4444;font-size:0.85rem;">Error loading notes.</p>';
    }
}

// ===== COACH MACRO ADJUSTMENT =====
function openCoachMacroModal() {
    if (!viewingAthleteId) return;
    var modal = document.getElementById('coachMacroModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Pre-fill current values from the displayed macros
    var curCal = document.getElementById('macroCals').textContent.replace(/,/g, '');
    var curP = document.getElementById('macroProtein').textContent;
    var curC = document.getElementById('macroCarbs').textContent;
    var curF = document.getElementById('macroFat').textContent;

    document.getElementById('cmCurrentCal').textContent = curCal !== '--' ? curCal : '--';
    document.getElementById('cmCurrentProtein').textContent = curP !== '--' ? curP + 'g' : '--';
    document.getElementById('cmCurrentCarbs').textContent = curC !== '--' ? curC + 'g' : '--';
    document.getElementById('cmCurrentFat').textContent = curF !== '--' ? curF + 'g' : '--';

    // Pre-fill new inputs with current values
    if (curCal !== '--') document.getElementById('cmNewCal').value = curCal;
    if (curP !== '--') document.getElementById('cmNewProtein').value = curP;
    if (curC !== '--') document.getElementById('cmNewCarbs').value = curC;
    if (curF !== '--') document.getElementById('cmNewFat').value = curF;

    document.getElementById('cmCoachNote').value = '';
    document.getElementById('cmSaveSuccess').style.display = 'none';
    document.getElementById('cmSaveError').style.display = 'none';
}

function closeCoachMacroModal() {
    document.getElementById('coachMacroModal').classList.remove('active');
    document.body.style.overflow = '';
}

document.getElementById('coachMacroModal').addEventListener('click', function(e) {
    if (e.target === this) closeCoachMacroModal();
});

async function coachSaveMacros(e) {
    e.preventDefault();
    if (!supabase || !currentUser || !viewingAthleteId) return;

    var phase = getPhaseInfo();
    var newCal = parseInt(document.getElementById('cmNewCal').value);
    var newProtein = parseInt(document.getElementById('cmNewProtein').value);
    var newCarbs = parseInt(document.getElementById('cmNewCarbs').value);
    var newFat = parseInt(document.getElementById('cmNewFat').value);
    var coachNote = document.getElementById('cmCoachNote').value.trim() || null;

    // Get previous values for change log
    var prevCal = null, prevProtein = null, prevCarbs = null, prevFat = null;
    try {
        var { data: prevData } = await supabase.from('saved_macros').select('calories, protein, carbs, fat')
            .eq('user_id', viewingAthleteId).eq('phase', phase.num).eq('year', phase.year).single();
        if (prevData) {
            prevCal = prevData.calories;
            prevProtein = prevData.protein;
            prevCarbs = prevData.carbs;
            prevFat = prevData.fat;
        }
    } catch (e) { /* no previous data */ }

    try {
        // 1. Upsert saved_macros
        var { error: macroErr } = await supabase.from('saved_macros').upsert({
            user_id: viewingAthleteId,
            phase: phase.num,
            year: phase.year,
            calories: newCal,
            protein: newProtein,
            carbs: newCarbs,
            fat: newFat
        }, { onConflict: 'user_id,phase,year' });
        if (macroErr) throw macroErr;

        // 2. Insert macro change log
        await supabase.from('macro_change_log').insert({
            athlete_id: viewingAthleteId,
            changed_by: currentUser.id,
            phase: phase.num,
            year: phase.year,
            prev_calories: prevCal,
            prev_protein: prevProtein,
            prev_carbs: prevCarbs,
            prev_fat: prevFat,
            new_calories: newCal,
            new_protein: newProtein,
            new_carbs: newCarbs,
            new_fat: newFat,
            coach_note: coachNote
        });

        // 3. Insert notification for athlete
        var msg = 'Calories: ' + newCal + ' | Protein: ' + newProtein + 'g | Carbs: ' + newCarbs + 'g | Fat: ' + newFat + 'g';
        if (coachNote) msg += ' — "' + coachNote + '"';
        await supabase.from('notifications').insert({
            user_id: viewingAthleteId,
            type: 'macro_update',
            title: 'Coach Updated Your Macros',
            message: msg
        });

        flashMessage('cmSaveSuccess');
        loadMacros(viewingAthleteId, phase);
        loadMacroChangeLog(viewingAthleteId);
        setTimeout(function() { closeCoachMacroModal(); }, 1500);
    } catch (err) {
        flashMessage('cmSaveError');
    }
}

async function loadMacroChangeLog(athleteId) {
    if (!supabase) return;
    var container = document.getElementById('macroChangeLogList');
    var empty = document.getElementById('macroLogEmpty');

    try {
        var { data, error } = await supabase.from('macro_change_log').select('*')
            .eq('athlete_id', athleteId)
            .order('created_at', { ascending: false })
            .limit(20);
        if (error) throw error;

        if (!data || data.length === 0) {
            container.innerHTML = '';
            empty.style.display = '';
            return;
        }

        empty.style.display = 'none';
        var html = '';
        data.forEach(function(entry) {
            var date = new Date(entry.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
            html += '<div class="macro-log-entry">';
            html += '<div class="macro-log-date">' + date + '</div>';
            html += '<div class="macro-log-values">';
            html += '<span>Cal: <strong>' + entry.new_calories + '</strong></span>';
            html += '<span>P: <strong>' + entry.new_protein + 'g</strong></span>';
            html += '<span>C: <strong>' + entry.new_carbs + 'g</strong></span>';
            html += '<span>F: <strong>' + entry.new_fat + 'g</strong></span>';
            html += '</div>';
            if (entry.coach_note) html += '<div class="macro-log-note">"' + entry.coach_note.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '"</div>';
            html += '</div>';
        });
        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = '';
    }
}

// ===== NOTIFICATIONS =====
async function loadNotifications(userId) {
    if (!supabase) return;
    try {
        var { data, error } = await supabase.from('notifications').select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(20);
        if (error) throw error;

        var list = document.getElementById('notificationList');
        var badge = document.getElementById('notificationBadge');
        var unreadCount = 0;

        if (!data || data.length === 0) {
            list.innerHTML = '<div class="notification-empty">No notifications</div>';
            badge.style.display = 'none';
            return;
        }

        var html = '';
        data.forEach(function(n) {
            if (!n.read) unreadCount++;
            var time = new Date(n.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            html += '<div class="notification-item' + (n.read ? '' : ' unread') + '" onclick="markNotificationRead(\'' + n.id + '\')">';
            html += '<div class="notification-item-title">' + (n.title || '').replace(/</g, '&lt;') + '</div>';
            html += '<div class="notification-item-message">' + (n.message || '').replace(/</g, '&lt;') + '</div>';
            html += '<div class="notification-item-time">' + time + '</div>';
            html += '</div>';
        });
        list.innerHTML = html;

        if (unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    } catch (e) {
        // notifications table may not exist yet — fail silently
    }
}

function toggleNotificationPanel() {
    var panel = document.getElementById('notificationPanel');
    panel.classList.toggle('active');
}

// Close notification panel when clicking outside
document.addEventListener('click', function(e) {
    var panel = document.getElementById('notificationPanel');
    var bell = document.getElementById('notificationBell');
    if (panel && bell && !panel.contains(e.target) && !bell.contains(e.target)) {
        panel.classList.remove('active');
    }
});

async function markNotificationRead(notifId) {
    if (!supabase) return;
    try {
        await supabase.from('notifications').update({ read: true }).eq('id', notifId);
        if (currentUser) loadNotifications(currentUser.id);
    } catch (e) { /* fail silently */ }
}

async function markAllNotificationsRead() {
    if (!supabase || !currentUser) return;
    try {
        await supabase.from('notifications').update({ read: true })
            .eq('user_id', currentUser.id).eq('read', false);
        loadNotifications(currentUser.id);
    } catch (e) { /* fail silently */ }
}

// ===== MACRO CHANGE BANNER (athlete side) =====
async function checkMacroChanges(userId, phase) {
    if (!supabase) return;
    try {
        var { data, error } = await supabase.from('macro_change_log').select('*')
            .eq('athlete_id', userId)
            .eq('phase', phase.num)
            .eq('year', phase.year)
            .eq('seen_by_athlete', false)
            .order('created_at', { ascending: false })
            .limit(1);
        if (error || !data || data.length === 0) return;

        var change = data[0];
        var banner = document.getElementById('macroChangeBanner');
        var valuesEl = document.getElementById('macroChangeValues');
        var noteEl = document.getElementById('macroChangeNote');

        var html = '';
        html += '<div class="macro-change-item"><div class="label">Calories</div><div class="values">';
        if (change.prev_calories) html += '<span class="old">' + change.prev_calories + '</span>';
        html += '<span class="new">' + change.new_calories + '</span></div></div>';
        html += '<div class="macro-change-item"><div class="label">Protein</div><div class="values">';
        if (change.prev_protein) html += '<span class="old">' + change.prev_protein + 'g</span>';
        html += '<span class="new">' + change.new_protein + 'g</span></div></div>';
        html += '<div class="macro-change-item"><div class="label">Carbs</div><div class="values">';
        if (change.prev_carbs) html += '<span class="old">' + change.prev_carbs + 'g</span>';
        html += '<span class="new">' + change.new_carbs + 'g</span></div></div>';
        html += '<div class="macro-change-item"><div class="label">Fat</div><div class="values">';
        if (change.prev_fat) html += '<span class="old">' + change.prev_fat + 'g</span>';
        html += '<span class="new">' + change.new_fat + 'g</span></div></div>';

        valuesEl.innerHTML = html;

        if (change.coach_note) {
            noteEl.textContent = '"' + change.coach_note + '"';
            noteEl.style.display = '';
        } else {
            noteEl.style.display = 'none';
        }

        banner.classList.add('active');
        // Store the change ID for dismissal
        banner.dataset.changeId = change.id;
    } catch (e) { /* fail silently */ }
}

async function dismissMacroChange() {
    var banner = document.getElementById('macroChangeBanner');
    var changeId = banner.dataset.changeId;
    banner.classList.remove('active');

    if (!supabase || !changeId) return;
    try {
        await supabase.from('macro_change_log').update({
            seen_by_athlete: true,
            seen_at: new Date().toISOString()
        }).eq('id', changeId);
    } catch (e) { /* fail silently */ }
}

// ===== ACCOUNT MODAL =====
function openAccountModal() {
    var modal = document.getElementById('accountModal');
    document.getElementById('accountEmail').textContent = currentUser ? currentUser.email : '';
    document.getElementById('accountRole').textContent = userRole;
    document.getElementById('accountDisplayName').value = userDisplayName || '';
    document.getElementById('accountNewPassword').value = '';
    document.getElementById('accountConfirmPassword').value = '';
    hideAccountMsg('displayNameMsg');
    hideAccountMsg('passwordMsg');
    modal.classList.add('active');
}

function closeAccountModal() {
    document.getElementById('accountModal').classList.remove('active');
}

function hideAccountMsg(id) {
    var el = document.getElementById(id);
    el.style.display = 'none';
    el.textContent = '';
    el.className = 'account-msg';
}

function showAccountMsg(id, msg, type) {
    var el = document.getElementById(id);
    el.textContent = msg;
    el.className = 'account-msg ' + type;
    el.style.display = 'block';
}

async function saveDisplayName() {
    var name = document.getElementById('accountDisplayName').value.trim();
    if (!name) {
        showAccountMsg('displayNameMsg', 'Please enter a display name.', 'error');
        return;
    }
    if (!supabase || !currentUser) return;
    try {
        var { error } = await supabase.from('profiles')
            .update({ display_name: name })
            .eq('id', currentUser.id);
        if (error) throw error;
        userDisplayName = name;
        showAccountMsg('displayNameMsg', 'Display name saved!', 'success');
    } catch (e) {
        console.log('Save display name error:', e);
        showAccountMsg('displayNameMsg', 'Failed to save. Please try again.', 'error');
    }
}

async function changePassword() {
    var newPw = document.getElementById('accountNewPassword').value;
    var confirmPw = document.getElementById('accountConfirmPassword').value;
    if (!newPw || !confirmPw) {
        showAccountMsg('passwordMsg', 'Please fill in both fields.', 'error');
        return;
    }
    if (newPw.length < 6) {
        showAccountMsg('passwordMsg', 'Password must be at least 6 characters.', 'error');
        return;
    }
    if (newPw !== confirmPw) {
        showAccountMsg('passwordMsg', 'Passwords do not match.', 'error');
        return;
    }
    if (!supabase) return;
    try {
        var { error } = await supabase.auth.updateUser({ password: newPw });
        if (error) throw error;
        showAccountMsg('passwordMsg', 'Password updated successfully!', 'success');
        document.getElementById('accountNewPassword').value = '';
        document.getElementById('accountConfirmPassword').value = '';
    } catch (e) {
        console.log('Change password error:', e);
        showAccountMsg('passwordMsg', e.message || 'Failed to update password.', 'error');
    }
}

// Close account modal on click outside
document.getElementById('accountModal').addEventListener('click', function(e) {
    if (e.target === this) closeAccountModal();
});

// ===== INIT =====
checkSession();
</script>

<script src="https://link.msgsndr.com/js/form_embed.js" type="text/javascript" defer></script>
<script src="https://widgets.leadconnectorhq.com/loader.js" data-resources-url="https://widgets.leadconnectorhq.com/chat-widget/loader.js" data-widget-id="6995d6d76e6009387f78d31e"></script>
</body>
</html>
